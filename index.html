<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÎœÎ·Î½Î¹Î±Î¯Î± ÎˆÎ¾Î¿Î´Î± Pro</title>

  <link rel="manifest" href="./manifest.json">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { primary: '#5D5CDE' }
        }
      }
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="./fonts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.3/Sortable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }
    .custom-scrollbar::-webkit-scrollbar{ width:8px; height:8px;}
    .custom-scrollbar::-webkit-scrollbar-track{ background:#f1f1f1; border-radius:10px;}
    .dark .custom-scrollbar::-webkit-scrollbar-track{ background:#374151;}
    .custom-scrollbar::-webkit-scrollbar-thumb{ background:#9ca3af; border-radius:10px;}
    .custom-scrollbar::-webkit-scrollbar-thumb:hover{ background:#6b7280;}
    .notification{ animation: slideInRight .25s ease-out;}
    @keyframes slideInRight{ from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1}}
    .sortable-ghost{ opacity:.4 }
    .drag-handle{ cursor:grab }
    .drag-handle:active{ cursor:grabbing }
    dialog::backdrop{ background: rgba(0,0,0,.35); }
    .confirmation-box {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      max-width: 350px;
      width: 90%;
      text-align: center;
    }
    .confirmation-box h3 {
      font-size: 1.25rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .confirmation-box p {
      margin-bottom: 1.5rem;
      color: #4a5568;
    }
  </style>
</head>

<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 h-full">
  <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <header class="border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <h1 class="text-3xl font-extrabold text-primary">ÎœÎ·Î½Î¹Î±Î¯Î± ÎˆÎ¾Î¿Î´Î± Pro</h1>
        <button id="themeToggle" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center hover:ring-2 ring-primary transition">
          <span id="themeIcon" class="text-lg">ğŸŒ™</span>
        </button>
      </div>
      <nav class="flex flex-wrap gap-2">
        <button class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm" id="btnManageCategories">ğŸ·ï¸ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½</button>
        <button class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm" id="btnBulk">ğŸ“… ÎœÎ±Î¶Î¹ÎºÎ® ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·</button>
        <button class="btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm" id="btnPDF">ğŸ“„ Î•Î¾Î±Î³Ï‰Î³Î® PDF</button>
        <button class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm" id="btnExport">ğŸ’¾ Export</button>
        <button class="btn bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm" id="btnImport">ğŸ“‚ Import</button>
<button id="btnAdd" class="hidden"></button>
<button class="btn bg-primary hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm" id="btnManageExpenses">ğŸ’° Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•Î¾ÏŒÎ´Ï‰Î½</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 space-y-4">
        <div class="flex items-center gap-4">
            <button id="prevMonthBtn" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center hover:ring-2 ring-primary transition text-lg">&lt;</button>
            <h2 id="currentMonth" class="text-2xl font-semibold flex-grow text-center"></h2>
            <button id="nextMonthBtn" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center hover:ring-2 ring-primary transition text-lg">&gt;</button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="p-4 rounded-lg bg-blue-100 dark:bg-blue-900/40">
            <div class="text-sm text-blue-700 dark:text-blue-300">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÎ¾Î¿Î´Î±</div>
            <div id="totalExpensesCount" class="text-xl font-bold">0</div>
          </div>
          <div class="p-4 rounded-lg bg-green-100 dark:bg-green-900/40">
            <div class="text-sm text-green-700 dark:text-green-300">Î Î»Î·ÏÏ‰Î¼Î­Î½Î±</div>
            <div id="paidCount" class="text-xl font-bold">0</div>
          </div>
          <div class="p-4 rounded-lg bg-red-100 dark:bg-red-900/40">
            <div class="text-sm text-red-700 dark:text-red-300">Î‘Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î±</div>
            <div id="unpaidCount" class="text-xl font-bold">0</div>
          </div>
          <div class="p-4 rounded-lg bg-yellow-100 dark:bg-yellow-900/40">
            <div class="text-sm text-yellow-700 dark:text-yellow-300">Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ</div>
            <div id="totalAmount" class="text-xl font-bold">0â‚¬</div>
          </div>
        </div>
      </div>
      <aside class="p-4 rounded-lg bg-gray-100 dark:bg-gray-800">
        <h3 class="text-lg font-semibold mb-3">Î‘Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î± ÎˆÎ¾Î¿Î´Î±</h3>
        <div id="upcomingReminders" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar text-sm"></div>
      </aside>
    </section>

    <section class="space-y-3">
      <h3 class="sr-only">Î¦Î¯Î»Ï„ÏÎ± ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½</h3>
      <div class="flex flex-wrap gap-2" id="categoryFilters">
        </div>
      <div class="flex flex-col md:flex-row items-center gap-3">
        <input id="searchInput" type="search" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Ï„Î¯Ï„Î»Î¿Ï…/ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÏ‰Î½â€¦" class="w-full md:w-80 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        <select id="statusFilter" class="w-full md:w-auto px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
          <option value="">ÎŒÎ»Î±</option>
          <option value="paid">ÎœÏŒÎ½Î¿ Ï€Î»Î·ÏÏ‰Î¼Î­Î½Î±</option>
          <option value="unpaid">ÎœÏŒÎ½Î¿ Î±Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î±</option>
        </select>
        <select id="sortSelect" class="w-full md:w-auto px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
          <option value="dueDateAsc">Î—Î¼/Î½Î¯Î± Î»Î®Î¾Î·Ï‚ â†‘</option>
          <option value="dueDateDesc">Î—Î¼/Î½Î¯Î± Î»Î®Î¾Î·Ï‚ â†“</option>
          <option value="amountDesc">Î Î¿ÏƒÏŒ â†“</option>
          <option value="amountAsc">Î Î¿ÏƒÏŒ â†‘</option>
          <option value="titleAsc">Î¤Î¯Ï„Î»Î¿Ï‚ Aâ€“Î©</option>
        </select>
      </div>
    </section>

    <section>
      <div class="overflow-hidden rounded-xl border border-gray-200 dark:border-gray-800">
        <div class="hidden lg:grid grid-cols-[32px_1fr_110px_130px_120px_100px_140px] gap-3 px-4 py-3 bg-gray-50 dark:bg-gray-800 text-xs font-semibold uppercase tracking-wide">
          <div></div>
          <div>Î¤Î¯Ï„Î»Î¿Ï‚</div>
          <div class="text-right">Î Î¿ÏƒÏŒ</div>
          <div>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</div>
          <div>Î—Î¼/Î½Î¯Î± Î›Î®Î¾Î·Ï‚</div>
          <div>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</div>
          <div>Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</div>
        </div>
        <ul id="expenseList" class="divide-y divide-gray-200 dark:divide-gray-800">
          </ul>
      </div>
    </section>
  </main>

  <footer class="mt-10 border-t border-gray-200 dark:border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-8">
      <div>
        <h4 class="font-bold text-lg">Î£Ï‡ÎµÏ„Î¹ÎºÎ¬</h4>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Î‘Ï…Ï„ÏŒÎ½Î¿Î¼Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚ Î¼Î·Î½Î¹Î±Î¯Ï‰Î½ ÎµÎ¾ÏŒÎ´Ï‰Î½ Î¼Îµ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î¿Î½ browser, Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¹ÎºÏ„Î¹ÎºÎ­Ï‚ Ï…Ï€ÎµÎ½Î¸Ï…Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ ÎµÎ¾Î±Î³Ï‰Î³Î® PDF/JSON.</p>
      </div>
    </div>
    <div class="text-center text-xs text-gray-500 dark:text-gray-400 pb-6">Â© <span id="year"></span> ÎœÎ·Î½Î¹Î±Î¯Î± ÎˆÎ¾Î¿Î´Î± Pro</div>
  </footer>

  <dialog id="addDialog" class="rounded-lg p-0 w-full max-w-lg">
    <form id="addForm" class="p-6 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" method="dialog">
      <h3 class="text-xl font-semibold mb-4">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·/Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î•Î¾ÏŒÎ´Î¿Ï…</h3>
      <input type="hidden" id="expenseId">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm">Î¤Î¯Ï„Î»Î¿Ï‚</label>
          <input id="titleInput" required class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        </div>
        <div>
          <label class="text-sm">Î Î¿ÏƒÏŒ (â‚¬)</label>
          <input id="amountInput" type="number" min="0" step="0.01" required class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        </div>
        <div>
          <label class="text-sm">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</label>
          <select id="categoryInput" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
            </select>
        </div>
        <div>
          <label class="text-sm">Î—Î¼/Î½Î¯Î± Î›Î®Î¾Î·Ï‚</label>
          <input id="dueDateInput" type="date" required class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        </div>
        <div class="md:col-span-2 grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm">Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ· (Î¼Î®Î½ÎµÏ‚)</label>
              <input id="repeatInput" type="number" min="0" value="0" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
            </div>
            <div>
              <label class="text-sm">Î’Î¬ÏƒÎ· Î•Ï€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚</label>
              <select id="repeatBaseInput" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
                <option value="due">Î‘Ï€ÏŒ Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î›Î®Î¾Î·Ï‚</option>
                <option value="payment">Î‘Ï€ÏŒ Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î Î»Î·ÏÏ‰Î¼Î®Ï‚</option>
              </select>
            </div>
        </div>
      </div>
      <div class="mt-3">
        <label class="text-sm">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
        <textarea id="notesInput" rows="3" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900"></textarea>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button type="button" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-800" onclick="el('addDialog').close()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        <button id="saveExpense" class="px-4 py-2 rounded-lg bg-primary text-white">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      </div>
    </form>
  </dialog>

  <dialog id="payDialog" class="rounded-lg p-0 w-full max-w-lg">
    <form id="payForm" class="p-6 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" method="dialog">
      <h3 class="text-xl font-semibold mb-4">ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î Î»Î·ÏÏ‰Î¼Î®Ï‚</h3>
      <input type="hidden" id="payExpenseId">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm">Î Î¿ÏƒÏŒ (â‚¬)</label>
          <input id="payAmount" type="number" min="0" step="0.01" required class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        </div>
        <div>
          <label class="text-sm">Î—Î¼/Î½Î¯Î± Î Î»Î·ÏÏ‰Î¼Î®Ï‚</label>
          <input id="payDate" type="date" required class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        </div>
        <div>
          <label class="text-sm">Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</label>
          <div class="flex items-center gap-2">
            <select id="payMethod" required class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
              </select>
            <button type="button" id="addPayMethod" class="w-10 h-10 flex-shrink-0 bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded-lg hover:ring-2 ring-primary transition">+</button>
          </div>
        </div>
        <div>
          <label class="text-sm">Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î£Ï…Î½Î±Î»Î»Î±Î³Î®Ï‚</label>
          <input id="payTransactionNumber" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        </div>
      </div>
      <div class="mt-3">
        <label class="text-sm">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</label>
        <textarea id="payNotes" rows="3" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900"></textarea>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button type="button" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-800" onclick="el('payDialog').close()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-green-600 text-white">ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î®</button>
      </div>
    </form>
  </dialog>

  <dialog id="bulkDialog" class="rounded-lg p-0 w-full max-w-xl">
    <div class="p-6 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
      <h3 class="text-xl font-semibold mb-4">ÎœÎ±Î¶Î¹ÎºÎ® Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎœÎ·Î½Î¹Î±Î¯Ï‰Î½ Î•Î¾ÏŒÎ´Ï‰Î½</h3>
      <div class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
        <div id="bulkList" class="divide-y divide-gray-200 dark:divide-gray-800">
          </div>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button type="button" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-800" onclick="el('bulkDialog').close()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        <button id="bulkSave" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î‘Î»Î»Î±Î³ÏÎ½</button>
      </div>
    </div>
  </dialog>

  <dialog id="categoryDialog" class="rounded-lg p-0 w-full max-w-lg">
    <div class="p-6 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
      <h3 class="text-xl font-semibold mb-4">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½</h3>
      <div class="flex justify-end mb-4">
        <button id="addCategoryBtn" class="bg-primary hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm">+ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚</button>
      </div>
      <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
        <ul id="categoryList" class="divide-y divide-gray-200 dark:divide-gray-800">
          </ul>
      </div>
      <form id="categoryForm" class="mt-6 space-y-3">
        <input type="hidden" id="categoryId">
        <div>
          <label class="text-sm">Î•Ï„Î¹ÎºÎ­Ï„Î±</label>
          <input id="categoryLabel" required class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        </div>
        <div>
          <label class="text-sm">Î•Î¹ÎºÎ¿Î½Î¯Î´Î¹Î¿ (emoji)</label>
          <input id="categoryIcon" class="w-full mt-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-800" onclick="el('categoryDialog').close()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        </div>
      </form>
    </div>
  </dialog>
  
  <dialog id="historyDialog" class="rounded-lg p-0 w-full max-w-sm">
    <div class="p-6 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
      <h3 class="text-xl font-semibold mb-4">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î Î»Î·ÏÏ‰Î¼ÏÎ½</h3>
      <div id="paymentHistoryList" class="space-y-4 custom-scrollbar max-h-64 overflow-y-auto">
        </div>
      <div class="mt-6 flex justify-between items-center">
        <button id="undoPaymentBtn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm" data-id="">Î‘Î½Î±Î¯ÏÎµÏƒÎ· Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±Ï‚</button>
        <button class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-800" onclick="el('historyDialog').close()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
    </div>
  </dialog>
  
  <dialog id="confirmation-dialog" class="confirmation-box">
    <h3 id="confirmation-title" class="text-gray-900 dark:text-gray-100">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</h3>
    <p id="confirmation-text" class="text-gray-600 dark:text-gray-400"></p>
    <div class="flex justify-center gap-4">
      <button id="confirm-cancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
      <button id="confirm-ok" class="px-4 py-2 rounded-lg bg-red-600 text-white">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</button>
    </div>
  </dialog>

<dialog id="manageExpensesDialog" class="rounded-lg p-0 w-full max-w-3xl">
  <div class="p-6 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <h3 class="text-xl font-semibold mb-4">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•Î¾ÏŒÎ´Ï‰Î½</h3>
    <div class="space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
      <ul id="manageExpenseList" class="divide-y divide-gray-200 dark:divide-gray-700"></ul>
    </div>
    <div class="mt-6 flex justify-end gap-2">
      <button type="button" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-800" onclick="el('manageExpensesDialog').close()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      <button id="addNewExpense" class="px-4 py-2 rounded-lg bg-primary text-white">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
    </div>
  </div>
</dialog>


  <input id="importInput" type="file" accept="application/json" class="hidden"/>

  <script>
    // =========================
    // Utilities & State
    // =========================
    const STORAGE_KEY = 'expenses_pro_v1';
    const THEME_KEY = 'theme_pref_v1';
    const CATEGORY_KEY = 'categories_v2';
    const PAYMENT_METHOD_KEY = 'payment_methods_v1';

    const el = id => document.getElementById(id);
    const fmtEUR = n => (Number(n)||0).toLocaleString('el-GR', {style:'currency', currency:'EUR'});
    const isMobile = () => window.innerWidth < 1024; // Use lg breakpoint for mobile detection

    let state = {
      expenses: [],
      currentViewDate: new Date(),
      filterCategory: '',
      statusFilter: '',
      search: '',
      sort: 'dueDateAsc'
    };
    
    // Default categories, used if localStorage is empty
    const defaultCategories = [
      { id:'home', label:'ğŸ  Î£Ï€Î¯Ï„Î¹', icon:'ğŸ ' },
      { id:'transport', label:'ğŸš— ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬', icon:'ğŸš—' },
      { id:'entertainment', label:'ğŸ¬ Î¨Ï…Ï‡Î±Î³Ï‰Î³Î¯Î±', icon:'ğŸ¬' },
      { id:'utilities', label:'âš¡ Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Î¯', icon:'âš¡' },
      { id:'food', label:'ğŸ” Î¦Î±Î³Î·Ï„ÏŒ', icon:'ğŸ”' },
      { id:'health', label:'ğŸ©º Î¥Î³ÎµÎ¯Î±', icon:'ğŸ©º' },
      { id:'education', label:'ğŸ“š Î•ÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ·', icon:'ğŸ“š' },
      { id:'other', label:'ğŸ—‚ï¸ Î†Î»Î»Î±', icon:'ğŸ—‚ï¸' }
    ];
    
    // Default payment methods
    const defaultPaymentMethods = [
        { id: 'cash', label: 'ÎœÎµÏ„ÏÎ·Ï„Î¬' },
        { id: 'card', label: 'ÎšÎ¬ÏÏ„Î±' },
        { id: 'bank_transfer', label: 'Î¤ÏÎ±Ï€ÎµÎ¶Î¹ÎºÎ® ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬' }
    ];

    // Seed demo data and migrate if needed
    function seedIfEmpty() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) {
        state.expenses = [
          mkExpense('Î•Î½Î¿Î¯ÎºÎ¹Î¿', 650, 'home', addDays(new Date(), 10), false, 'ÎœÎ·Î½Î¹Î±Î¯Î± Ï…Ï€Î¿Ï‡ÏÎ­Ï‰ÏƒÎ·', 1, 'due'),
          mkExpense('Î”Î•Î—', 85.45, 'utilities', addDays(new Date(), 3), false, 'Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·', 0, 'due'),
          mkExpense('Internet', 30, 'utilities', addDays(new Date(), 5), false, 'Î Î»Î·ÏÏÎ¸Î·ÎºÎµ Î¼Î­ÏƒÏ‰ e-banking', 1, 'due'),
          mkExpense('Super Market', 120.90, 'food', addDays(new Date(), 2), false, '', 0, 'due'),
          mkExpense('ÎšÎ¹Î½Î·Ï„ÏŒ', 17.50, 'utilities', addDays(new Date(), 18), false, '', 0, 'due'),
        ];
        persist();
      } else {
        try { 
            state.expenses = JSON.parse(saved); 
            // Migrate old data model if needed
            state.expenses.forEach(exp => {
                // Ensure payments array exists
                if (!exp.payments) exp.payments = [];
                // If old boolean 'paid' existed, migrate to payments (handled previously)
                if (typeof exp.paid !== 'undefined' && !exp.payments.length) {
                    if (exp.paid) {
                        const paymentDate = exp.paymentDates?.[0] || (exp.createdAt ? exp.createdAt.split('T')[0] : toYMD(new Date()));
                        exp.payments.push({
                            amount: exp.amount,
                            date: paymentDate,
                            method: 'migration',
                            notes: 'Î‘ÏÏ‡Î¹ÎºÎ® Ï€Î»Î·ÏÏ‰Î¼Î® (Î¼ÎµÏ„Î±Î½Î¬ÏƒÏ„ÎµÏ…ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½)',
                            transactionNumber: ''
                        });
                    }
                    delete exp.paid;
                    delete exp.paymentDates;
                }
                // Ensure repeatBase exists (default to 'due')
                if (!exp.repeatBase) exp.repeatBase = 'due';
            });
        } catch { state.expenses = []; }
      }
      const catSaved = localStorage.getItem(CATEGORY_KEY);
      if (!catSaved) localStorage.setItem(CATEGORY_KEY, JSON.stringify(defaultCategories));
      const payMethodSaved = localStorage.getItem(PAYMENT_METHOD_KEY);
      if (!payMethodSaved) localStorage.setItem(PAYMENT_METHOD_KEY, JSON.stringify(defaultPaymentMethods));
    }

    function mkExpense(title, amount, category, dueDate, paid=false, notes='', repeatInterval=0, repeatBase='due') {
      return {
        id: crypto.randomUUID(),
        title: String(title).trim(),
        amount: Number(amount)||0,
        category: category || 'other',
        dueDate: toYMD(dueDate),
        notes: String(notes||''),
        repeatInterval: Number(repeatInterval) || 0,
        repeatBase: repeatBase || 'due', // 'due' or 'payment'
        createdAt: new Date().toISOString(),
        payments: []
      };
    }

    function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.expenses)); }
    function persistCategories(){ localStorage.setItem(CATEGORY_KEY, JSON.stringify(getCategories())); }
    function persistPaymentMethods(){ localStorage.setItem(PAYMENT_METHOD_KEY, JSON.stringify(getPaymentMethods())); }

    function addMonths(date, months) {
        let d = new Date(date);
        // preserve day; JS handles month overflow
        d.setMonth(d.getMonth() + months);
        return d;
    }

    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function toYMD(d){ if(!d) return ''; const dt=new Date(d); const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const day=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function fromYMD(s){ return s? new Date(s+'T00:00:00'): null; }
    
    // Simple notification system
    function notify(msg, type='info'){
      const colors = {
        info:'bg-gray-900 text-white',
        success:'bg-green-600 text-white',
        error:'bg-red-600 text-white',
        warn:'bg-yellow-500 text-black'
      };
      const n = document.createElement('div');
      n.className = `notification ${colors[type]||colors.info} px-4 py-2 rounded shadow-lg`;
      n.textContent = msg;
      el('notifications').appendChild(n);
      setTimeout(()=>{ n.remove(); }, 2500);
    }
    
    // Confirmation dialog
    function showConfirmation(message, onConfirm) {
      const dialog = el('confirmation-dialog');
      el('confirmation-text').textContent = message;

      // Set up event listeners for the buttons
      const okBtn = el('confirm-ok');
      const cancelBtn = el('confirm-cancel');

      // We use .onclick to prevent multiple event listeners from stacking up
      okBtn.onclick = () => {
        dialog.close();
        onConfirm();
      };
      cancelBtn.onclick = () => {
        dialog.close();
      };
      
      // Show the dialog as a modal, blocking other interactions
      dialog.showModal();
    }


    // =========================
    // Theme
    // =========================
    function applyStoredTheme(){
      const pref = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
      document.documentElement.classList.toggle('dark', pref==='dark');
      el('themeIcon').textContent = pref==='dark'?'â˜€ï¸':'ğŸŒ™';
    }
    function toggleTheme(){
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem(THEME_KEY, isDark?'dark':'light');
      el('themeIcon').textContent = isDark?'â˜€ï¸':'ğŸŒ™';
    }

    // =========================
    // Rendering
    // =========================
    function renderHeader(){
      const currentMonth = state.currentViewDate.toLocaleDateString('el-GR', { month: 'long', year: 'numeric' });
      el('currentMonth').textContent = `${currentMonth.charAt(0).toUpperCase() + currentMonth.slice(1)}`;
      el('year').textContent = new Date().getFullYear();
    }
    
    function changeMonth(offset) {
        state.currentViewDate.setMonth(state.currentViewDate.getMonth() + offset);
        renderAll();
    }

    function getCategories(){ try { return JSON.parse(localStorage.getItem(CATEGORY_KEY))||defaultCategories; } catch { return defaultCategories; } }
    function getPaymentMethods(){ try { return JSON.parse(localStorage.getItem(PAYMENT_METHOD_KEY))||defaultPaymentMethods; } catch { return defaultPaymentMethods; } }

    function renderFilters(){
      const cats = [{ id: '', label: 'ÎŒÎ»ÎµÏ‚ Î¿Î¹ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚', icon: '' }, ...getCategories()];
      const wrap = document.getElementById('categoryFilters');
      wrap.innerHTML = '';
      // Render filter buttons
      cats.forEach(c=>{
        const btn = document.createElement('button');
        btn.className = `px-3 py-1 rounded-full text-sm transition-colors ${state.filterCategory===c.id ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`;
        btn.textContent = c.label;
        btn.addEventListener('click', ()=>{ state.filterCategory=c.id; renderAll(); });
        wrap.appendChild(btn);
      });
      // Render select options for add dialog
      const categorySelect = el('categoryInput');
      categorySelect.innerHTML = '';
      getCategories().forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.label;
        categorySelect.appendChild(option);
      });
    }
    
    function renderPaymentMethods() {
        const select = el('payMethod');
        select.innerHTML = '';
        getPaymentMethods().forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.label;
            select.appendChild(option);
        });
    }
    
    function getFilteredExpenses() {
        const year = state.currentViewDate.getFullYear();
        const month = state.currentViewDate.getMonth();
        return state.expenses.filter(x => {
            const expenseDate = fromYMD(x.dueDate);
            return expenseDate && expenseDate.getFullYear() === year && expenseDate.getMonth() === month;
        });
    }

    function applyFilters(expenses){
      let items = [...expenses];
      if (state.filterCategory) items = items.filter(x=> x.category===state.filterCategory);
      if (state.statusFilter==='paid') items = items.filter(x=> x.payments && x.payments.length > 0);
      if (state.statusFilter==='unpaid') items = items.filter(x=> !x.payments || x.payments.length === 0);
      if (state.search){
        const q = state.search.toLowerCase();
        items = items.filter(x=> x.title.toLowerCase().includes(q) || (x.notes||'').toLowerCase().includes(q));
      }
      switch(state.sort){
        case 'dueDateAsc': items.sort((a,b)=> (a.dueDate||'').localeCompare(b.dueDate||'')); break;
        case 'dueDateDesc': items.sort((a,b)=> (b.dueDate||'').localeCompare(a.dueDate||'')); break;
        case 'amountDesc': items.sort((a,b)=> b.amount - a.amount); break;
        case 'amountAsc': items.sort((a,b)=> a.amount - b.amount); break;
        case 'titleAsc': items.sort((a,b)=> a.title.localeCompare(b.title)); break;
      }
      return items;
    }

    function renderStats(){
      const monthlyExpenses = getFilteredExpenses();
      const total = monthlyExpenses.length;
      const paid = monthlyExpenses.filter(x => x.payments && x.payments.length > 0).length;
      const unpaid = total - paid;
      const sum = monthlyExpenses.reduce((acc,x)=> acc + (Number(x.amount)||0), 0);
      el('totalExpensesCount').textContent = String(total);
      el('paidCount').textContent = String(paid);
      el('unpaidCount').textContent = String(unpaid);
      el('totalAmount').textContent = fmtEUR(sum);
    }

    function renderReminders(){
  const holder = el('upcomingReminders');
  holder.innerHTML = '';

  const now = state.currentViewDate;
  const year = now.getFullYear();
  const month = now.getMonth();

  const unpaid = state.expenses
    .filter(x => {
      if (x.payments && x.payments.length > 0) return false;
      const d = fromYMD(x.dueDate);
      if (!d) return false;
      // Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ Î­Î¾Î¿Î´Î± Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ ÎºÎ±Î¹ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Ï‰Î½ Î¼Î·Î½ÏÎ½
      return (d.getFullYear() < year) ||
             (d.getFullYear() === year && d.getMonth() <= month);
    })
    .sort((a,b) => (a.dueDate||'').localeCompare(b.dueDate||''));

  if (!unpaid.length){
    holder.innerHTML = `<div class="text-gray-500">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î± Î­Î¾Î¿Î´Î±.</div>`;
    return;
  }

  unpaid.forEach(x => {
    const d = new Date(x.dueDate).toLocaleDateString('el-GR');
    const row = document.createElement('div');
    row.className = "flex items-center justify-between bg-white dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2";
    row.innerHTML = `
      <div class="text-sm"><span class="font-semibold">${x.title}</span> â€” <span class="opacity-80">${d}</span></div>
      <div class="font-bold">${fmtEUR(x.amount)}</div>
    `;
    holder.appendChild(row);
  });
}


    function renderList(){
      const list = el('expenseList');
      list.innerHTML = '';
      const monthlyExpenses = getFilteredExpenses();
      const filtered = applyFilters(monthlyExpenses);
      const getCategoryLabel = (id) => {
        const cat = getCategories().find(c => c.id === id);
        return cat ? (isMobile() ? cat.icon : cat.label) : id;
      };

      if (!filtered.length){
        list.innerHTML = `<li class="p-6 text-center text-gray-500">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î­Î¾Î¿Î´Î± Ï€Î¿Ï… Î½Î± Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½ Î¼Îµ Ï„Î± Ï†Î¯Î»Ï„ÏÎ±.</li>`;
        return;
      }

      filtered.forEach(x=>{
        const li = document.createElement('li');
        li.dataset.id = x.id;
        li.className = "group relative transition-all";
        const isPaid = x.payments && x.payments.length > 0;
        const paidClass = isPaid ? 'line-through opacity-60' : '';
        // small badge for repeat base
        const repeatBadge = x.repeatInterval > 0 ? `<span class="ml-2 text-xs px-2 py-1 rounded-full ${x.repeatBase === 'payment' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}">${x.repeatInterval}m â€¢ ${x.repeatBase === 'payment' ? 'Î Î»Î®ÏÏ‰ÏƒÎ·Ï‚' : 'Î›Î®Î¾Î·Ï‚'}</span>` : '';
        
        li.innerHTML = `
        <div class="absolute inset-y-0 -left-6 flex items-center justify-center w-6">
            <div class="drag-handle w-4 h-4 rounded-full bg-gray-400 dark:bg-gray-600"></div>
        </div>

        <div class="lg:hidden flex flex-col gap-2 p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <button class="toggle-status-btn" data-id="${x.id}" aria-label="Î•Î½Î±Î»Î»Î±Î³Î® ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚">
                        <div class="w-6 h-6 rounded-full border-2 border-current ${isPaid ? 'bg-green-500 border-green-500' : ''}"></div>
                    </button>
                    <div class="font-medium ${paidClass}">${x.title} ${repeatBadge}</div>
                </div>
                <div class="font-bold text-lg ${paidClass}">${fmtEUR(x.amount)}</div>
            </div>
            <div class="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
                <div class="flex items-center gap-2">
                    <span>${getCategoryLabel(x.category)}</span>
                    <span class="text-xs font-semibold uppercase rounded-full px-2 py-1 ${isPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${isPaid ? 'Î Î›Î—Î¡Î©ÎœÎ•ÎÎŸ' : 'Î‘ÎÎ•ÎÎŸÎ¦Î›Î—Î¤ÎŸ'}</span>
                </div>
                <div>${new Date(x.dueDate).toLocaleDateString('el-GR')}</div>
            </div>
            <div class="flex items-center gap-2 mt-2">
                <button class="edit-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${x.id}" title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13.5l-5 5v3h3l5-5-3-3zM16 5l-4.5 4.5M19 8l-4.5-4.5"></path></svg>
                </button>
                ${isPaid ?
                `<button class="history-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${x.id}" title="Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î Î»Î·ÏÏ‰Î¼ÏÎ½">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>` :
                `<button class="pay-btn p-2 rounded-full bg-green-500 text-white hover:bg-green-600" data-id="${x.id}" title="ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î Î»Î·ÏÏ‰Î¼Î®Ï‚">
                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0v5m-5-5a4 4 0 100 8h2m6-8a4 4 0 110 8h2m-6-4h4m-5 4h8a2 2 0 002-2v-2a2 2 0 00-2-2h-8a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg>
                </button>`}
                <button class="delete-btn p-2 rounded-full hover:bg-red-200 dark:hover:bg-red-700" data-id="${x.id}" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®">
                  <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </div>

        <div class="hidden lg:grid grid-cols-[32px_1fr_110px_130px_120px_100px_140px] items-center gap-3 p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer">
          <button class="toggle-status-btn" data-id="${x.id}" aria-label="Î•Î½Î±Î»Î»Î±Î³Î® ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚">
            <div class="w-6 h-6 rounded-full border-2 border-current ${isPaid ? 'bg-green-500 border-green-500' : ''}"></div>
          </button>
          <div class="space-y-1">
            <div class="font-medium ${paidClass}">${x.title} ${repeatBadge}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400 overflow-hidden text-ellipsis whitespace-nowrap">${x.notes}</div>
          </div>
          <div class="font-semibold text-right ${paidClass}">${fmtEUR(x.amount)}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 ${paidClass}">${getCategoryLabel(x.category)}</div>
          <div class="text-sm font-light ${paidClass}">${new Date(x.dueDate).toLocaleDateString('el-GR')}</div>
          <div class="text-xs text-center font-semibold uppercase rounded-full px-2 py-1 ${paidClass} ${isPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
            ${isPaid ? 'Î Î›Î—Î¡Î©ÎœÎ•ÎÎŸ' : 'Î‘ÎÎ•ÎÎŸÎ¦Î›Î—Î¤ÎŸ'}
          </div>
          <div class="flex items-center gap-2">
            <button class="edit-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${x.id}" title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13.5l-5 5v3h3l5-5-3-3zM16 5l-4.5 4.5M19 8l-4.5-4.5"></path></svg>
            </button>
            ${isPaid ?
            `<button class="history-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${x.id}" title="Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î Î»Î·ÏÏ‰Î¼ÏÎ½">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>` :
            `<button class="pay-btn px-3 py-1 rounded-lg bg-green-500 text-white hover:bg-green-600" data-id="${x.id}" title="ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î Î»Î·ÏÏ‰Î¼Î®Ï‚">
              <svg class="w-4 h-4 mr-1 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0v5m-5-5a4 4 0 100 8h2m6-8a4 4 0 110 8h2m-6-4h4m-5 4h8a2 2 0 002-2v-2a2 2 0 00-2-2h-8a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg>
               Î Î»Î·ÏÏ‰Î¼Î®
            </button>`}
            <button class="delete-btn p-2 rounded-full hover:bg-red-200 dark:hover:bg-red-700" data-id="${x.id}" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®">
              <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
        </div>
        `;
        list.appendChild(li);
      });

      // Initialize Sortable.js
      new Sortable(list, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: (evt) => {
          const itemEl = evt.item;
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          const item = filtered.find(x => x.id === itemEl.dataset.id);
          
          if(oldIndex !== newIndex) {
            const reorderedItems = applyFilters(getFilteredExpenses());
            const movedItem = reorderedItems.splice(oldIndex, 1)[0];
            reorderedItems.splice(newIndex, 0, movedItem);
            
            const newExpenseOrder = reorderedItems.map(item => item.id);
            state.expenses.sort((a,b) => newExpenseOrder.indexOf(a.id) - newExpenseOrder.indexOf(b.id));

            persist();
          }
        }
      });
    }

    function renderAll(){
      renderHeader();
      renderFilters();
      renderPaymentMethods();
      renderStats();
      renderReminders();
      renderList();
    }

    // =========================
    // Actions
    // =========================
    function getExpenseById(id){ return state.expenses.find(x => x.id === id); }
    function deleteExpense(id){
      const exp = getExpenseById(id);
      showConfirmation(`Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿ Î­Î¾Î¿Î´Î¿ "${exp.title}"; Î‘Ï…Ï„Î® Î· ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± Î´ÎµÎ½ Î±Î½Î±ÏƒÏ„ÏÎ­Ï†ÎµÏ„Î±Î¹.`, () => {
        state.expenses = state.expenses.filter(x=>x.id!==id);
        persist();
        renderAll();
        notify('Î¤Î¿ Î­Î¾Î¿Î´Î¿ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ.', 'success');
      });
    }

    function handleStatusClick(id) {
        const exp = getExpenseById(id);
        if (!exp) return;
        if (exp.payments && exp.payments.length > 0) {
            showPaymentHistory(id);
        } else {
            openPayDialog(id);
        }
    }
    
    function openAddDialog(id){
      const dialog = el('addDialog');
      const form = el('addForm');
      const expense = id ? getExpenseById(id) : null;
      
      form.reset();
      el('expenseId').value = id || '';
      
      if(expense){
        el('titleInput').value = expense.title;
        el('amountInput').value = expense.amount;
        el('categoryInput').value = expense.category;
        el('dueDateInput').value = expense.dueDate;
        el('repeatInput').value = expense.repeatInterval;
        el('repeatBaseInput').value = expense.repeatBase || 'due';
        el('notesInput').value = expense.notes;
      } else {
        // Set default due date to the last day of the current view month
        const lastDayOfMonth = new Date(state.currentViewDate.getFullYear(), state.currentViewDate.getMonth() + 1, 0);
        el('dueDateInput').value = toYMD(lastDayOfMonth);
        el('repeatInput').value = 0;
        el('repeatBaseInput').value = 'due';
      }
      dialog.showModal();
    }
    
    function saveExpense(e){
      e.preventDefault();
      const id = el('expenseId').value;
      const title = el('titleInput').value;
      const amount = el('amountInput').value;
      const category = el('categoryInput').value;
      const dueDate = el('dueDateInput').value;
      const repeatInterval = Number(el('repeatInput').value) || 0;
      const repeatBase = el('repeatBaseInput').value || 'due';
      const notes = el('notesInput').value;
      
      if(id){
        const exp = getExpenseById(id);
        if(exp){
          Object.assign(exp, { title, amount, category, dueDate, notes, repeatInterval, repeatBase });
          notify('Î¤Î¿ Î­Î¾Î¿Î´Î¿ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ!', 'success');
        }
      } else {
        const newExp = mkExpense(title, amount, category, dueDate, false, notes, repeatInterval, repeatBase);
        state.expenses.unshift(newExp);
        notify('Î¤Î¿ Î­Î¾Î¿Î´Î¿ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!', 'success');
      }
      
      persist();
      renderAll();
      el('addDialog').close();
    }

    function openPayDialog(id){
      const dialog = el('payDialog');
      const expense = getExpenseById(id);
      if(!expense) return;
      
      el('payExpenseId').value = id;
      el('payAmount').value = expense.amount;
      el('payDate').value = toYMD(new Date());
      el('payNotes').value = '';
      el('payTransactionNumber').value = '';

      renderPaymentMethods();
      dialog.showModal();
    }
    
    function handlePayment(e){
        e.preventDefault();
        const id = el('payExpenseId').value;
        const exp = getExpenseById(id);
        if (!exp) return;

        const newPayment = {
            amount: Number(el('payAmount').value) || 0,
            date: el('payDate').value,
            method: el('payMethod').value,
            notes: el('payNotes').value,
            transactionNumber: el('payTransactionNumber').value
        };

        if (!exp.payments) exp.payments = [];
        exp.payments.push(newPayment);

        // If paid and has a repeat interval, create a new one
if (exp.repeatInterval > 0) {
    const baseDate = exp.repeatBase === 'payment' ? fromYMD(newPayment.date) : fromYMD(exp.dueDate);
    const nextDueDate = addMonths(baseDate, exp.repeatInterval);
    const newExp = mkExpense(exp.title, exp.amount, exp.category, nextDueDate, false, exp.notes, exp.repeatInterval, exp.repeatBase);
    state.expenses.unshift(newExp);
}
        
        persist();
        renderAll();
        notify('Î— Ï€Î»Î·ÏÏ‰Î¼Î® ÎºÎ±Ï„Î±Î³ÏÎ¬Ï†Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!', 'success');
        el('payDialog').close();
    }

    function openBulkDialog() {
        renderBulkList();
        el('bulkDialog').showModal();
    }
    
    function renderBulkList() {
        const bulkList = el('bulkList');
        bulkList.innerHTML = '';
        const monthlyExpenses = applyFilters(getFilteredExpenses());

        if (monthlyExpenses.length === 0) {
            bulkList.innerHTML = `<p class="p-4 text-center text-gray-500">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­Î¾Î¿Î´Î± Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î±.</p>`;
            return;
        }

        monthlyExpenses.forEach(exp => {
            const isPaid = exp.payments && exp.payments.length > 0;
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors';
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="h-5 w-5 rounded form-checkbox text-green-600 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600" data-id="${exp.id}" ${isPaid ? 'checked' : ''}>
                    <div>
                        <div class="font-medium">${exp.title}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${fmtEUR(exp.amount)} - ${new Date(exp.dueDate).toLocaleDateString('el-GR')}</div>
                    </div>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    ${(exp.payments && exp.payments.length > 0) ? `Î Î»Î·ÏÏ‰Î¼Î­Î½Î¿` : `Î‘Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î¿`}
                </div>
            `;
            bulkList.appendChild(item);
        });
    }

    function handleBulkSave() {
        const checkboxes = el('bulkList').querySelectorAll('input[type="checkbox"]');
        const now = toYMD(new Date());
        
        checkboxes.forEach(cb => {
            const id = cb.dataset.id;
            const exp = getExpenseById(id);
            if (!exp) return;

            const wasPaid = exp.payments && exp.payments.length > 0;
            const isNowPaid = cb.checked;
            
            if (isNowPaid && !wasPaid) {
                // Mark as paid
                if (!exp.payments) exp.payments = [];
                exp.payments.push({
                    amount: exp.amount,
                    date: now,
                    method: 'bulk_update',
                    notes: 'ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î¼Î­ÏƒÏ‰ Î¼Î±Î¶Î¹ÎºÎ®Ï‚ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚',
                    transactionNumber: ''
                });

                // If repeat create next
                if (exp.repeatInterval > 0) {
                    const lastPaymentDate = fromYMD(now);
                    const baseDate = exp.repeatBase === 'payment' ? lastPaymentDate : fromYMD(exp.dueDate);
                    const nextDueDate = addMonths(baseDate, exp.repeatInterval);
                    const newExp = mkExpense(exp.title, exp.amount, exp.category, nextDueDate, false, exp.notes, exp.repeatInterval, exp.repeatBase);
                    state.expenses.unshift(newExp);
                }

            } else if (!isNowPaid && wasPaid) {
                // Unmark as paid (undo last payment)
                exp.payments.pop();
            }
        });

        persist();
        renderAll();
        notify('ÎŸÎ¹ Î±Î»Î»Î±Î³Î­Ï‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!', 'success');
        el('bulkDialog').close();
    }


    async function exportData(){
        const data = JSON.stringify(state.expenses, null, 2);
        const fileName = `expenses_export_${toYMD(new Date())}.json`;
        
        if ('showSaveFilePicker' in window) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'JSON Files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });
                const writable = await handle.createWritable();
                await writable.write(data);
                await writable.close();
                notify('Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎ¾Î®Ï‡Î¸Î·ÏƒÎ±Î½!', 'success');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error(err);
                    notify('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ¾Î±Î³Ï‰Î³Î®Ï‚. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.', 'error');
                }
            }
        } else {
            // Fallback for browsers without showSaveFilePicker
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            notify('Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎ¾Î®Ï‡Î¸Î·ÏƒÎ±Î½! (Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ ÏƒÏ„Î¿ Ï†Î¬ÎºÎµÎ»Î¿ Î›Î®ÏˆÎµÏ‰Î½)', 'success');
        }
    }

  function importData(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const importedExpenses = JSON.parse(event.target.result);
          if (Array.isArray(importedExpenses) && importedExpenses.every(x => x.id && x.title)){
            // Ensure repeatBase exists in imported items
            importedExpenses.forEach(exp => { if (!exp.repeatBase) exp.repeatBase = 'due'; if (!exp.payments) exp.payments = []; });
            state.expenses = importedExpenses;
            persist();
            renderAll();
            notify('Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎ¹ÏƒÎ®Ï‡Î¸Î·ÏƒÎ±Î½ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±!', 'success');
          } else {
            throw new Error('Invalid JSON format');
          }
        } catch (err){
          notify('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚. ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ Î±ÏÏ‡ÎµÎ¯Î¿ JSON.', 'error');
          console.error(err);
        }
      };
      reader.readAsText(file);
    }

    function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFont("Inter", "normal"); // âœ… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î·Î½ Inter
  doc.setFontSize(22);
  doc.text("ÎœÎ·Î½Î¹Î±Î¯Î± ÎˆÎ¾Î¿Î´Î± Pro", 14, 20)
      doc.setFont("Helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Î•Î¾Î±Î³Ï‰Î³Î® Î³Î¹Î± Ï„Î¿Î½ Î¼Î®Î½Î±: ${el('currentMonth').textContent}`, 14, 26);
      
      const tableData = applyFilters(getFilteredExpenses()).map(exp => [
        exp.title,
        fmtEUR(exp.amount),
        getCategories().find(c => c.id === exp.category)?.label || exp.category,
        new Date(exp.dueDate).toLocaleDateString('el-GR'),
        (exp.payments && exp.payments.length > 0) ? 'Î Î»Î·ÏÏ‰Î¼Î­Î½Î¿' : 'Î‘Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î¿'
      ]);

         doc.autoTable({
        startY: 35,
        head: [['Î¤Î¯Ï„Î»Î¿Ï‚', 'Î Î¿ÏƒÏŒ', 'ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±', 'Î—Î¼/Î½Î¯Î± Î›Î®Î¾Î·Ï‚', 'ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·']],
        body: tableData,
      });

      doc.save(`expenses_${toYMD(new Date())}.pdf`);
    }

    function showPaymentHistory(id){
        const exp = getExpenseById(id);
        if (!exp || !exp.payments || exp.payments.length === 0) return;

        const list = el('paymentHistoryList');
        list.innerHTML = '';
        exp.payments.forEach((p, idx) => {
            const item = document.createElement('div');
            item.className = 'border-b border-gray-200 dark:border-gray-700 pb-2';
            item.innerHTML = `
              <div class="font-medium">${fmtEUR(p.amount)} - ${new Date(p.date).toLocaleDateString('el-GR')}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">ÎœÎ­Î¸Î¿Î´Î¿Ï‚: ${p.method}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚: ${p.notes||''}</div>
              ${p.transactionNumber ? `<div class="text-xs text-gray-500 dark:text-gray-400">Î£Ï…Î½Î±Î»Î»Î±Î³Î®: ${p.transactionNumber}</div>` : ''}
            `;
            list.appendChild(item);
        });
        el('undoPaymentBtn').dataset.id = exp.id;
        el('historyDialog').showModal();
    }

function undoLastPayment() {
  const id = el('undoPaymentBtn').dataset.id;
  const exp = getExpenseById(id);
  if (!exp || !exp.payments || exp.payments.length === 0) return;

  exp.payments.pop();

  persist();
  renderAll();
  notify('Î— Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Ï€Î»Î·ÏÏ‰Î¼Î® Î±Î½Î±Î¹ÏÎ­Î¸Î·ÎºÎµ!', 'warn');
  el('historyDialog').close();
}
    // =========================
    // Event Bindings
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
        seedIfEmpty();
        applyStoredTheme();
        renderAll();

        el('themeToggle').addEventListener('click', toggleTheme);
        el('btnAdd').addEventListener('click', ()=> openAddDialog());
        el('saveExpense').addEventListener('click', saveExpense);
        el('addForm').addEventListener('submit', saveExpense);

        el('prevMonthBtn').addEventListener('click', ()=> changeMonth(-1));
        el('nextMonthBtn').addEventListener('click', ()=> changeMonth(1));

        el('statusFilter').addEventListener('change', e=> { state.statusFilter=e.target.value; renderAll(); });
        el('searchInput').addEventListener('input', e=> { state.search=e.target.value; renderAll(); });
        el('sortSelect').addEventListener('change', e=> { state.sort=e.target.value; renderAll(); });

        el('btnPDF').addEventListener('click', generatePDF);
        el('btnExport').addEventListener('click', exportData);
        el('btnImport').addEventListener('click', ()=> el('importInput').click());
        el('importInput').addEventListener('change', importData);

        el('btnBulk').addEventListener('click', openBulkDialog);
        el('bulkSave').addEventListener('click', handleBulkSave);

        el('payForm').addEventListener('submit', handlePayment);
        el('undoPaymentBtn').addEventListener('click', undoLastPayment);

        // Delegated events for dynamic list
        el('expenseList').addEventListener('click', (e)=>{
            const btn = e.target.closest('button');
            if (!btn) return;
            if (btn.classList.contains('delete-btn')) deleteExpense(btn.dataset.id);
            else if (btn.classList.contains('edit-btn')) openAddDialog(btn.dataset.id);
            else if (btn.classList.contains('pay-btn')) openPayDialog(btn.dataset.id);
            else if (btn.classList.contains('toggle-status-btn')) handleStatusClick(btn.dataset.id);
            else if (btn.classList.contains('history-btn')) showPaymentHistory(btn.dataset.id);
        });

        // Manage categories
        el('btnManageCategories').addEventListener('click', () => {
            renderCategoryList();
            el('categoryDialog').showModal();
        });
        el('categoryForm').addEventListener('submit', saveCategory);
        el('addCategoryBtn').addEventListener('click', () => {
            el('categoryId').value = '';
            el('categoryLabel').value = '';
            el('categoryIcon').value = '';
        });
        el('categoryList').addEventListener('click', (e)=>{
            const btn = e.target.closest('button');
            if (!btn) return;
            if (btn.classList.contains('edit-category')) editCategory(btn.dataset.id);
            else if (btn.classList.contains('delete-category')) deleteCategory(btn.dataset.id);
        });

        // Manage payment methods
        el('addPayMethod').addEventListener('click', () => {
            const newMethod = prompt("ÎÎ­Î± Î¼Î­Î¸Î¿Î´Î¿Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚:");
            if (newMethod) {
                const methods = getPaymentMethods();
                methods.push({ id: crypto.randomUUID(), label: newMethod });
                localStorage.setItem(PAYMENT_METHOD_KEY, JSON.stringify(methods));
                renderPaymentMethods();
            }
        });
    });

    // =========================
    // Categories
    // =========================
    function renderCategoryList() {
        const list = el('categoryList');
        list.innerHTML = '';
        const cats = getCategories();
        cats.forEach(c => {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-gray-800 rounded';
            li.innerHTML = `
              <div class="flex items-center gap-2">
                <span>${c.icon}</span>
                <span>${c.label}</span>
              </div>
              <div class="flex gap-2">
                <button class="edit-category px-2 py-1 rounded bg-blue-500 text-white text-xs" data-id="${c.id}">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</button>
                <button class="delete-category px-2 py-1 rounded bg-red-500 text-white text-xs" data-id="${c.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
              </div>
            `;
            list.appendChild(li);
        });
    }

    function saveCategory(e) {
        e.preventDefault();
        const id = el('categoryId').value || crypto.randomUUID();
        const label = el('categoryLabel').value.trim();
        const icon = el('categoryIcon').value.trim() || 'ğŸ—‚ï¸';
        if (!label) return;
        let cats = getCategories();
        const existing = cats.find(c=>c.id===id);
        if (existing) {
            existing.label = label;
            existing.icon = icon;
        } else {
            cats.push({ id, label, icon });
        }
        localStorage.setItem(CATEGORY_KEY, JSON.stringify(cats));
        renderCategoryList();
        renderFilters();
        notify('Î— ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!', 'success');
        el('categoryDialog').close();
    }

    function editCategory(id) {
        const c = getCategories().find(x=>x.id===id);
        if (!c) return;
        el('categoryId').value = c.id;
        el('categoryLabel').value = c.label;
        el('categoryIcon').value = c.icon;
    }

    function deleteCategory(id) {
        showConfirmation("Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±;", () => {
            let cats = getCategories().filter(c=>c.id!==id);
            localStorage.setItem(CATEGORY_KEY, JSON.stringify(cats));
            renderCategoryList();
            renderFilters();
            notify('Î— ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ!', 'success');
        });
    }

// =========================
// Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•Î¾ÏŒÎ´Ï‰Î½ (ÎÎ­Î¿Ï‚ Î”Î¹Î¬Î»Î¿Î³Î¿Ï‚)
// =========================
function renderManageExpenses() {
  const list = el('manageExpenseList');
  list.innerHTML = '';

  // Î”ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ Î¼ÏŒÎ½Î¿ Î±Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î±
  const expenses = state.expenses.filter(x => !x.payments || x.payments.length === 0);

  if (expenses.length === 0) {
    list.innerHTML = `<li class="p-6 text-center text-gray-500">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î± Î­Î¾Î¿Î´Î±.</li>`;
    return;
  }

  expenses
    .sort((a,b)=> new Date(b.dueDate) - new Date(a.dueDate))
    .forEach(exp => {
      const li = document.createElement('li');
      const d = new Date(exp.dueDate).toLocaleDateString('el-GR');
      li.className = "flex justify-between items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-800";
      li.innerHTML = `
        <div>
          <div class="font-medium">${exp.title}</div>
          <div class="text-sm text-gray-500">${fmtEUR(exp.amount)} â€¢ ${d}</div>
        </div>
        <div class="flex gap-2">
          <button class="edit-expense px-2 py-1 rounded bg-blue-500 text-white text-xs" data-id="${exp.id}">âœï¸ Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</button>
          <button class="delete-expense px-2 py-1 rounded bg-red-500 text-white text-xs" data-id="${exp.id}">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
        </div>
      `;
      list.appendChild(li);
    });
}

// Î†Î½Î¿Î¹Î³Î¼Î± Î”Î¹Î±Î»ÏŒÎ³Î¿Ï… Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚ Î•Î¾ÏŒÎ´Ï‰Î½
el('btnManageExpenses').addEventListener('click', () => {
  renderManageExpenses();
  el('manageExpensesDialog').showModal();
});

// Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î½Î­Î¿Ï… ÎµÎ¾ÏŒÎ´Î¿Ï…
el('addNewExpense').addEventListener('click', () => {
  el('manageExpensesDialog').close();
  openAddDialog();
});

// Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î± Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚
el('manageExpenseList').addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  if (btn.classList.contains('edit-expense')) {
    el('manageExpensesDialog').close();
    openAddDialog(btn.dataset.id);
  } else if (btn.classList.contains('delete-expense')) {
    deleteExpense(btn.dataset.id);
    renderManageExpenses();
  }
});


  </script>
</body>
</html>
