<!DOCTYPE html>
<html lang="el" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Μηνιαία Έξοδα Pro</title>

  <link rel="manifest" href="./manifest.json">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { primary: '#5D5CDE' }
        }
      }
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.3/Sortable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @media print {
      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .no-print { display: none; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 font-sans h-full overflow-hidden">

  <div id="app" class="h-full w-full flex flex-col">

    <header class="bg-primary text-white p-4 shadow-md no-print relative">
      <div class="container mx-auto flex items-center justify-between">
        <h1 class="text-2xl font-bold flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
          Μηνιαία Έξοδα Pro
        </h1>
        <div class="flex items-center">
          <div class="relative group ml-4">
            <button id="menuBtn" class="flex items-center justify-center w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-white/50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
              </svg>
            </button>
            <div id="menuContent" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-50">
              <button id="importBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">Εισαγωγή</button>
              <button id="exportBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">Εξαγωγή</button>
              <button id="printBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">Εκτύπωση</button>
              <button id="darkModeBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
                <span id="darkModeText">Σκοτεινή Λειτουργία</span>
              </button>
              <button id="installBtn" class="hidden w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">Εγκατάσταση Εφαρμογής</button>
              <button id="aboutBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">Σχετικά με</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-grow overflow-hidden flex flex-col p-4 no-print">
      
      <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-2 md:space-y-0 md:space-x-4">
        <div class="flex-grow w-full md:w-auto">
          <input type="text" id="searchInput" placeholder="Αναζήτηση..." class="w-full p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-800 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div class="flex items-center space-x-2 w-full md:w-auto">
          <select id="statusFilter" class="p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-800 rounded-md focus:outline-none focus:ring-2 focus:ring-primary w-1/2 md:w-auto">
            <option value="all">Όλα</option>
            <option value="due">Απλήρωτα</option>
            <option value="paid">Πληρωμένα</option>
          </select>
          <select id="sortSelect" class="p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-800 rounded-md focus:outline-none focus:ring-2 focus:ring-primary w-1/2 md:w-auto">
            <option value="dueDateAsc">Ημερομηνία (παλαιότερο)</option>
            <option value="dueDateDesc">Ημερομηνία (νεότερο)</option>
            <option value="amountAsc">Ποσό (αύξουσα)</option>
            <option value="amountDesc">Ποσό (φθίνουσα)</option>
          </select>
        </div>
      </div>
      
      <div class="flex-grow overflow-y-auto no-scrollbar pb-4" id="expenseList">
        </div>
      
      <div class="no-print mt-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md flex items-center justify-between">
        <span class="text-lg font-semibold">Σύνολο: <span id="totalAmount">0.00€</span></span>
        <button id="addExpenseBtn" class="px-4 py-2 bg-primary text-white rounded-md font-semibold hover:bg-blue-600 transition-colors duration-200">
          Προσθήκη Εξόδου
        </button>
      </div>
      
    </main>

    <div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <h2 id="modalTitle" class="text-xl font-bold mb-4">Νέο Έξοδο</h2>
        <form id="expenseForm">
          <input type="hidden" id="expenseId" name="id">
          <div class="mb-4">
            <label for="title" class="block text-sm font-medium mb-1">Τίτλος</label>
            <input type="text" id="title" name="title" class="w-full p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
          </div>
          <div class="mb-4">
            <label for="amount" class="block text-sm font-medium mb-1">Ποσό (€)</label>
            <input type="number" id="amount" name="amount" class="w-full p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" step="0.01" required>
          </div>
          <div class="mb-4">
            <label for="category" class="block text-sm font-medium mb-1">Κατηγορία</label>
            <select id="category" name="category" class="w-full p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="none">Καμία</option>
              <option value="Ενοίκιο">Ενοίκιο</option>
              <option value="Λογαριασμοί">Λογαριασμοί</option>
              <option value="Διατροφή">Διατροφή</option>
              <option value="Μετακίνηση">Μετακίνηση</option>
              <option value="Ψυχαγωγία">Ψυχαγωγία</option>
              <option value="Υγεία">Υγεία</option>
              <option value="Εκπαίδευση">Εκπαίδευση</option>
              <option value="Άλλα">Άλλα</option>
            </select>
          </div>
          <div class="mb-4">
            <label for="dueDate" class="block text-sm font-medium mb-1">Ημερομηνία Λήξης</label>
            <input type="date" id="dueDate" name="dueDate" class="w-full p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
          </div>
          <div class="mb-4">
            <label for="repeatInterval" class="block text-sm font-medium mb-1">Επανάληψη (μήνες)</label>
            <input type="number" id="repeatInterval" name="repeatInterval" class="w-full p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" value="0">
          </div>
          <div class="mb-4">
            <label for="notes" class="block text-sm font-medium mb-1">Σημειώσεις</label>
            <textarea id="notes" name="notes" class="w-full p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelExpenseBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">Ακύρωση</button>
            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition-colors duration-200">Αποθήκευση</button>
          </div>
        </form>
      </div>
    </div>

    <div id="payModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Καταγραφή Πληρωμής</h2>
        <form id="payForm">
          <input type="hidden" id="payExpenseId">
          <div class="mb-4">
            <label for="payDate" class="block text-sm font-medium mb-1">Ημερομηνία Πληρωμής</label>
            <input type="date" id="payDate" class="w-full p-2 border border-gray-300 dark:border-gray-700 dark:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelPayBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">Ακύρωση</button>
            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition-colors duration-200">Καταγραφή</button>
          </div>
        </form>
      </div>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
        <h2 class="text-xl font-bold mb-4">Ιστορικό Πληρωμών</h2>
        <div id="historyList" class="max-h-96 overflow-y-auto no-scrollbar">
          </div>
        <div class="flex justify-end mt-4">
          <button type="button" id="closeHistoryBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">Κλείσιμο</button>
        </div>
      </div>
    </div>
    
    <div id="aboutModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-center">
        <h2 class="text-xl font-bold mb-2">Σχετικά με</h2>
        <p class="mb-4">
          Αυτό το απλό PWA δημιουργήθηκε για να σας βοηθήσει να διαχειριστείτε τα μηνιαία σας έξοδα.
        </p>
        <div class="flex flex-col items-center space-y-2">
          <a href="https://github.com/george-gregory/monthly-expenses-pro" target="_blank" class="text-primary hover:underline flex items-center">
            <svg class="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.83 9.504.5.092.682-.217.682-.483 0-.237-.008-.865-.013-1.7-2.782.604-3.37-1.34-3.37-1.34-.454-1.156-1.11-1.46-1.11-1.46-.908-.62.068-.607.068-.607 1.004.07 1.532 1.03 1.532 1.03.89 1.527 2.343 1.084 2.91.828.092-.64.35-1.084.636-1.334-2.22-.25-4.555-1.11-4.555-4.943 0-1.09.39-1.984 1.03-2.675-.104-.252-.448-1.264.098-2.643 0 0 .84-.268 2.75 1.026.798-.222 1.63-.332 2.47-.337.838.005 1.67.115 2.47.337 1.91-1.294 2.75-1.026 2.75-1.026.546 1.379.202 2.39.098 2.643.64.69 1.03 1.584 1.03 2.675 0 3.842-2.335 4.69-4.565 4.935.36.31.678.92.678 1.855 0 1.336-.013 2.415-.013 2.748 0 .267.18.575.688.482C20.145 20.2 23 16.446 23 12.017 23 6.484 18.522 2 13 2z" clip-rule="evenodd" />
            </svg>
            GitHub Repository
          </a>
        </div>
        <div class="flex justify-end mt-4">
          <button type="button" id="closeAboutBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">Κλείσιμο</button>
        </div>
      </div>
    </div>
    
  </div>

  <script>
    // Global state
    const state = {
      expenses: JSON.parse(localStorage.getItem('expenses')) || [],
      search: '',
      statusFilter: 'all',
      sort: 'dueDateAsc',
      isDarkMode: localStorage.getItem('darkMode') === 'true'
    };

    // Helper functions
    const el = (id) => document.getElementById(id);
    const formatDate = (date) => date.toISOString().split('T')[0];
    const fromYMD = (s) => s? new Date(s+'T00:00:00'): null;
    const toYMD = (d) => d? d.toISOString().split('T')[0]: null;

    // Correct date handling to avoid timezone issues
    function fromYMD_safe(s) {
        if (!s) return null;
        const parts = s.split('-');
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }
    
    function addMonths(date, months) {
        const d = new Date(date);
        const originalDay = d.getDate();
        d.setDate(1); // Set to day 1 to avoid month overflow issues
        d.setMonth(d.getMonth() + months);
        const lastDayOfNewMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
        d.setDate(Math.min(originalDay, lastDayOfNewMonth));
        return d;
    }

    const mkId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    const mkExpense = (title, amount, category, dueDate, isPaid, notes, repeatInterval, history = []) => ({
      id: mkId(),
      title,
      amount: parseFloat(amount),
      category,
      dueDate: toYMD(dueDate),
      isPaid,
      notes,
      repeatInterval: parseInt(repeatInterval, 10),
      history
    });

    // CRUD operations
    const saveState = () => {
      localStorage.setItem('expenses', JSON.stringify(state.expenses));
      renderList();
      updateTotal();
    };

    const addExpense = (expense) => {
      state.expenses.unshift(expense);
      saveState();
    };

    const editExpense = (id, newExp) => {
      const index = state.expenses.findIndex(exp => exp.id === id);
      if (index !== -1) {
        state.expenses[index] = { ...state.expenses[index], ...newExp };
        saveState();
      }
    };

    const deleteExpense = (id) => {
      if (confirm('Είστε σίγουροι ότι θέλετε να διαγράψετε αυτό το έξοδο;')) {
        state.expenses = state.expenses.filter(exp => exp.id !== id);
        saveState();
      }
    };
    
    const payExpense = (id, payDate) => {
      const expense = state.expenses.find(exp => exp.id === id);
      if (expense) {
        // Record payment in history
        expense.history.push({ date: payDate, amount: expense.amount });
        
        // If paid and has a repeat interval, create a new one
        if (expense.repeatInterval > 0) {
          // Fix: Use the paid date to calculate the next due date
          const nextDueDate = addMonths(fromYMD_safe(payDate), expense.repeatInterval);
          const newExp = mkExpense(expense.title, expense.amount, expense.category, nextDueDate, false, expense.notes, expense.repeatInterval, []);
          state.expenses.unshift(newExp);
        }

        // Remove the original expense
        state.expenses = state.expenses.filter(exp => exp.id !== id);

        saveState();
      }
    };
    
    // Rendering
    const renderList = () => {
      let filtered = state.expenses.filter(exp => {
        const matchesSearch = exp.title.toLowerCase().includes(state.search.toLowerCase());
        const isPaid = exp.history.length > 0;
        const matchesStatus = state.statusFilter === 'all' || (state.statusFilter === 'due' && !isPaid) || (state.statusFilter === 'paid' && isPaid);
        return matchesSearch && matchesStatus;
      });

      filtered.sort((a, b) => {
        if (state.sort === 'dueDateAsc') return new Date(a.dueDate) - new Date(b.dueDate);
        if (state.sort === 'dueDateDesc') return new Date(b.dueDate) - new Date(a.dueDate);
        if (state.sort === 'amountAsc') return a.amount - b.amount;
        if (state.sort === 'amountDesc') return b.amount - a.amount;
        return 0;
      });

      const listContainer = el('expenseList');
      listContainer.innerHTML = '';

      if (filtered.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 mt-8">Δεν βρέθηκαν έξοδα.</p>';
        return;
      }

      filtered.forEach(exp => {
        const isPaid = exp.history.length > 0;
        const isDue = !isPaid && new Date(exp.dueDate) < new Date();
        const cardClass = isPaid ? 'bg-green-100 dark:bg-green-800' : isDue ? 'bg-red-100 dark:bg-red-800' : 'bg-white dark:bg-gray-800';
        const buttonColorClass = isPaid ? 'bg-green-600 hover:bg-green-700' : 'bg-primary hover:bg-blue-600';
        
        const expenseElement = document.createElement('div');
        expenseElement.id = `exp-${exp.id}`;
        expenseElement.className = `${cardClass} p-4 rounded-lg shadow-md mb-3 flex items-start justify-between transition-transform transform hover:scale-[1.01] duration-150 ease-in-out cursor-grab`;
        expenseElement.setAttribute('data-id', exp.id);
        
        expenseElement.innerHTML = `
          <div class="flex-grow">
            <h3 class="text-xl font-bold">${exp.title}</h3>
            <p class="text-lg font-semibold text-primary mt-1">${exp.amount.toFixed(2)}€</p>
            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400">Λήξη: ${exp.dueDate ? new Date(exp.dueDate + 'T00:00:00').toLocaleDateString('el-GR') : 'N/A'}</p>
            ${exp.category !== 'none' ? `<span class="inline-block bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs px-2 py-1 rounded-full mt-2">${exp.category}</span>` : ''}
          </div>
          <div class="flex flex-col space-y-2 no-print">
            <button class="pay-btn px-3 py-1 text-white rounded-md text-sm font-medium transition-colors duration-200 ${buttonColorClass}">
              ${isPaid ? 'Πληρώθηκε' : 'Πληρωμή'}
            </button>
            <button class="edit-btn px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">
              Επεξεργασία
            </button>
            ${isPaid ? `
              <button class="history-btn px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">
                Ιστορικό
              </button>
            ` : ''}
            <button class="delete-btn px-3 py-1 bg-red-500 text-white rounded-md text-sm font-medium hover:bg-red-600 transition-colors duration-200">
              Διαγραφή
            </button>
          </div>
        `;
        listContainer.appendChild(expenseElement);
      });
      
      new Sortable(listContainer, {
          animation: 150,
          onEnd: (evt) => {
              const itemEl = evt.item; // dragged HTMLElement
              const oldIndex = evt.oldIndex;
              const newIndex = evt.newIndex;
              
              if (oldIndex !== newIndex) {
                  const expenseId = itemEl.getAttribute('data-id');
                  const movedExpense = state.expenses.find(exp => exp.id === expenseId);
                  state.expenses.splice(oldIndex, 1);
                  state.expenses.splice(newIndex, 0, movedExpense);
                  saveState();
              }
          }
      });
    };

    const updateTotal = () => {
      const total = state.expenses.filter(exp => exp.history.length === 0).reduce((sum, exp) => sum + exp.amount, 0);
      el('totalAmount').textContent = total.toFixed(2) + '€';
    };
    
    // Modal management
    const showModal = (modalId) => {
      const modal = el(modalId);
      modal.classList.remove('hidden');
    };
    const hideModal = (modalId) => {
      const modal = el(modalId);
      modal.classList.add('hidden');
    };
    
    const openAddDialog = () => {
      el('modalTitle').textContent = 'Νέο Έξοδο';
      el('expenseId').value = '';
      el('title').value = '';
      el('amount').value = '';
      el('category').value = 'none';
      el('dueDate').value = toYMD(new Date());
      el('repeatInterval').value = 0;
      el('notes').value = '';
      showModal('expenseModal');
    };
    
    const openEditDialog = (id) => {
      const expense = state.expenses.find(exp => exp.id === id);
      if (expense) {
        el('modalTitle').textContent = 'Επεξεργασία Εξόδου';
        el('expenseId').value = expense.id;
        el('title').value = expense.title;
        el('amount').value = expense.amount;
        el('category').value = expense.category;
        el('dueDate').value = expense.dueDate;
        el('repeatInterval').value = expense.repeatInterval;
        el('notes').value = expense.notes;
        showModal('expenseModal');
      }
    };
    
    const openPayDialog = (id) => {
      const expense = state.expenses.find(exp => exp.id === id);
      if (expense) {
        el('payExpenseId').value = expense.id;
        el('payDate').value = toYMD(new Date());
        showModal('payModal');
      }
    };
    
    const showPaymentHistory = (id) => {
        const expense = state.expenses.find(exp => exp.id === id);
        if (expense && expense.history.length > 0) {
            const historyList = el('historyList');
            historyList.innerHTML = '';
            expense.history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-3 mb-2 bg-gray-100 dark:bg-gray-700 rounded-md';
                historyItem.innerHTML = `
                    <p class="text-sm">Πληρωμή: ${new Date(item.date).toLocaleDateString('el-GR')}</p>
                    <p class="font-semibold">${item.amount.toFixed(2)}€</p>
                `;
                historyList.appendChild(historyItem);
            });
            showModal('historyModal');
        } else {
            alert('Δεν υπάρχει ιστορικό πληρωμών για αυτό το έξοδο.');
        }
    };

    // Dark Mode
    const toggleDarkMode = () => {
      state.isDarkMode = !state.isDarkMode;
      localStorage.setItem('darkMode', state.isDarkMode);
      updateDarkModeClass();
    };

    const updateDarkModeClass = () => {
      if (state.isDarkMode) {
        document.documentElement.classList.add('dark');
        el('darkModeText').textContent = 'Φωτεινή Λειτουργία';
      } else {
        document.documentElement.classList.remove('dark');
        el('darkModeText').textContent = 'Σκοτεινή Λειτουργία';
      }
    };

    // Export/Import
    const exportData = () => {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.expenses, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "μηνιαία-έξοδα.json");
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    };

    const importData = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const importedExpenses = JSON.parse(event.target.result);
            state.expenses = importedExpenses;
            saveState();
            alert('Τα δεδομένα εισήχθησαν με επιτυχία!');
          } catch (error) {
            alert('Σφάλμα κατά την εισαγωγή δεδομένων. Βεβαιωθείτε ότι το αρχείο είναι έγκυρο.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };
    
    // Print
    const printList = () => {
        window.print();
    };

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      updateDarkModeClass();
      renderList();
      updateTotal();
      
      // Global click listener for modals
      window.addEventListener('click', (event) => {
        if (event.target === el('expenseModal')) hideModal('expenseModal');
        if (event.target === el('payModal')) hideModal('payModal');
        if (event.target === el('historyModal')) hideModal('historyModal');
        if (event.target === el('aboutModal')) hideModal('aboutModal');
      });
      
      el('addExpenseBtn').addEventListener('click', openAddDialog);
      el('cancelExpenseBtn').addEventListener('click', () => hideModal('expenseModal'));
      el('cancelPayBtn').addEventListener('click', () => hideModal('payModal'));
      el('closeHistoryBtn').addEventListener('click', () => hideModal('historyModal'));
      el('closeAboutBtn').addEventListener('click', () => hideModal('aboutModal'));
      
      // Menu functionality
      const menuBtn = el('menuBtn');
      const menuContent = el('menuContent');
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        menuContent.classList.toggle('hidden');
      });
      document.addEventListener('click', (e) => {
        if (!menuContent.contains(e.target) && e.target !== menuBtn) {
          menuContent.classList.add('hidden');
        }
      });
      
      el('darkModeBtn').addEventListener('click', toggleDarkMode);
      el('exportBtn').addEventListener('click', exportData);
      el('importBtn').addEventListener('click', importData);
      el('printBtn').addEventListener('click', printList);
      el('aboutBtn').addEventListener('click', () => { hideModal('expenseModal'); hideModal('payModal'); showModal('aboutModal'); });

      el('expenseForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = el('expenseId').value;
        const newExpense = {
          title: el('title').value,
          amount: el('amount').value,
          category: el('category').value,
          dueDate: el('dueDate').value,
          notes: el('notes').value,
          repeatInterval: el('repeatInterval').value
        };
        
        if (id) {
          editExpense(id, newExpense);
        } else {
          addExpense(mkExpense(newExpense.title, newExpense.amount, newExpense.category, fromYMD(newExpense.dueDate), false, newExpense.notes, newExpense.repeatInterval));
        }
        hideModal('expenseModal');
      });
      
      el('payForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = el('payExpenseId').value;
        const payDate = el('payDate').value;
        payExpense(id, payDate);
        hideModal('payModal');
      });
      
      el('expenseList').addEventListener('click', (e) => {
        const target = e.target;
        const card = target.closest('[data-id]');
        if (!card) return;
        const id = card.getAttribute('data-id');

        if(target.classList.contains('edit-btn')) {
          openEditDialog(id);
        } else if(target.classList.contains('pay-btn') && confirm('Θέλετε να καταχωρίσετε την πληρωμή για αυτό το έξοδο;')) {
          openPayDialog(id);
        } else if(target.classList.contains('history-btn')) {
          showPaymentHistory(id);
        } else if(target.classList.contains('delete-btn')) {
          deleteExpense(id);
        }
      });

      el('searchInput').addEventListener('input', (e) => {
        state.search = e.target.value;
        renderList();
      });
      el('statusFilter').addEventListener('change', (e) => {
        state.statusFilter = e.target.value;
        renderList();
      });
      el('sortSelect').addEventListener('change', (e) => {
        state.sort = e.target.value;
        renderList();
      });
    });
    
    // === PWA Functionality ===
    
    // Check if the browser supports Service Workers
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // IMPORTANT: Replace <repository-name> with your actual repository name
        navigator.serviceWorker.register('/<repository-name>/sw.js').then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }

    // This code handles the installation prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      el('installBtn').classList.remove('hidden');
    });

    el('installBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
            el('installBtn').classList.add('hidden');
          } else {
            console.log('User dismissed the install prompt');
          }
          deferredPrompt = null;
        });
      }
    });
  </script>
</body>
</html>
