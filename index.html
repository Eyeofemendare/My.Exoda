<!DOCTYPE html>
<html lang="el" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Μηνιαία Έξοδα Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5d5cee">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --primary-color: #5d5cee;
        --secondary-color: #4a49c9;
        --text-color: #1a202c;
        --bg-color: #f7fafc;
        --card-bg: #ffffff;
      }
      .dark {
        --primary-color: #6d6afc;
        --secondary-color: #5d5cee;
        --text-color: #e2e8f0;
        --bg-color: #1a202c;
        --card-bg: #2d3748;
      }
      .bg-primary { background-color: var(--primary-color); }
      .bg-secondary { background-color: var(--secondary-color); }
      .text-primary { color: var(--primary-color); }
      .text-secondary { color: var(--secondary-color); }
      body { background-color: var(--bg-color); color: var(--text-color); }
      .card { background-color: var(--card-bg); }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }
      .notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        animation: fadeInOut 3s forwards;
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translate(-50%, 20px); }
        10% { opacity: 1; transform: translate(-50%, 0); }
        90% { opacity: 1; transform: translate(-50%, 0); }
        100% { opacity: 0; transform: translate(-50%, 20px); }
      }
      .sortable-ghost {
        opacity: 0.5;
        background-color: var(--primary-color);
        color: white;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script>
</head>
<body class="p-4 lg:p-8 font-sans transition-colors duration-300">

    <div id="notifications" class="fixed inset-x-0 bottom-4 flex flex-col items-center space-y-2 z-[1000]"></div>

    <div class="max-w-7xl mx-auto grid lg:grid-cols-[1fr_2fr] gap-8">
        
        <aside class="space-y-6">
            <header class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <h1 class="text-3xl font-bold text-primary">Έξοδα Pro</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <span id="themeIcon">🌙</span>
                    </button>
                    <button id="btnAdd" class="p-2 rounded-full bg-primary text-white hover:bg-secondary transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>
            </header>
            
            <div class="card p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h2 id="currentMonth" class="text-xl font-semibold text-center text-primary"></h2>
                    <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div id="totalExpensesCount" class="text-3xl font-bold text-primary">0</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Σύνολο</div>
                    </div>
                    <div>
                        <div id="paidCount" class="text-3xl font-bold text-green-500">0</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Πληρωμένα</div>
                    </div>
                    <div>
                        <div id="unpaidCount" class="text-3xl font-bold text-red-500">0</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Ανεξόφλητα</div>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-lg text-gray-500 dark:text-gray-400 font-medium">Συνολικό Ποσό Μήνα:</div>
                    <div id="totalAmount" class="text-3xl font-bold text-right text-primary">€0.00</div>
                </div>
            </div>
            
            <div class="card p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Επόμενες Πληρωμές</h3>
                    <button id="btnBulk" class="text-primary text-sm font-medium hover:underline">Μαζική Ενημέρωση</button>
                </div>
                <div id="upcomingReminders" class="space-y-3">
                    </div>
            </div>

            <div class="card p-6 rounded-2xl shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Εργαλεία</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button id="btnManageCategories" class="flex flex-col items-center justify-center p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-6 h-6 mb-1 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2H7z"></path></svg>
                        <span class="text-sm">Κατηγορίες</span>
                    </button>
                    <button id="btnExport" class="flex flex-col items-center justify-center p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-6 h-6 mb-1 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span class="text-sm">Εξαγωγή</span>
                    </button>
                    <button id="btnImport" class="flex flex-col items-center justify-center p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-6 h-6 mb-1 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M4 12l4-4m0 0l4 4m-4-4V4"></path></svg>
                        <span class="text-sm">Εισαγωγή</span>
                        <input type="file" id="importInput" accept=".json" class="hidden" onchange="importData(event)">
                    </button>
                    <button id="btnPDF" class="flex flex-col items-center justify-center p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-6 h-6 mb-1 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2-8H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2z"></path></svg>
                        <span class="text-sm">Εξαγωγή PDF</span>
                    </button>
                </div>
            </div>

            <footer class="text-center text-sm text-gray-500 dark:text-gray-400 mt-8">
                <p>© <span id="year"></span> Μηνιαία Έξοδα Pro</p>
                <p>Made with ❤️ for a better financial life.</p>
            </footer>
        </aside>

        <main class="space-y-6 lg:border-l lg:border-gray-200 dark:lg:border-gray-700 lg:pl-8">
            <div class="space-y-4">
                <div class="flex flex-col lg:flex-row gap-4">
                    <input type="text" id="searchInput" placeholder="Αναζήτηση..." class="w-full lg:w-1/3 p-2 rounded-lg card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary">
                    <select id="statusFilter" class="w-full lg:w-auto p-2 rounded-lg card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Όλα τα Έξοδα</option>
                        <option value="unpaid">Ανεξόφλητα</option>
                        <option value="paid">Πληρωμένα</option>
                    </select>
                    <select id="sortSelect" class="w-full lg:w-auto p-2 rounded-lg card shadow-sm focus:outline-none focus:ring-2 focus:ring-primary">
                      <option value="dueDateAsc">Ημ/νία (Αύξουσα)</option>
                      <option value="dueDateDesc">Ημ/νία (Φθίνουσα)</option>
                      <option value="amountDesc">Ποσό (Φθίνουσα)</option>
                      <option value="amountAsc">Ποσό (Αύξουσα)</option>
                      <option value="titleAsc">Τίτλος (Αύξουσα)</option>
                    </select>
                </div>
                <div id="categoryFilters" class="flex flex-wrap gap-2">
                    </div>
            </div>
            
            <div class="card p-2 rounded-2xl shadow-lg overflow-hidden">
                <div class="hidden lg:grid grid-cols-[32px_1fr_110px_130px_120px_100px_140px] gap-3 px-4 py-3 font-semibold text-sm text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                    <div></div>
                    <div>Τίτλος</div>
                    <div class="text-right">Ποσό</div>
                    <div>Κατηγορία</div>
                    <div>Λήξη</div>
                    <div class="text-center">Κατάσταση</div>
                    <div>Ενέργειες</div>
                </div>
                <ul id="expenseList" class="divide-y divide-gray-200 dark:divide-gray-700">
                    </ul>
            </div>
        </main>
    </div>

    <dialog id="addDialog" class="p-6 rounded-2xl shadow-xl dark:bg-gray-800 dark:text-white">
        <h3 class="text-2xl font-bold mb-4">Προσθήκη / Επεξεργασία Εξόδου</h3>
        <form id="addForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" id="expenseId">
            <div class="col-span-1 md:col-span-2 space-y-2">
                <label for="titleInput" class="block font-medium">Τίτλος</label>
                <input type="text" id="titleInput" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="space-y-2">
                <label for="amountInput" class="block font-medium">Ποσό (€)</label>
                <input type="number" id="amountInput" step="0.01" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="space-y-2">
                <label for="categoryInput" class="block font-medium">Κατηγορία</label>
                <select id="categoryInput" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                    </select>
            </div>
            <div class="space-y-2">
                <label for="dueDateInput" class="block font-medium">Ημ/νία Λήξης</label>
                <input type="date" id="dueDateInput" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="space-y-2">
                <label for="repeatInput" class="block font-medium">Επανάληψη (μήνες)</label>
                <input type="number" id="repeatInput" value="0" min="0" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="col-span-1 md:col-span-2 space-y-2">
                <label for="notesInput" class="block font-medium">Σημειώσεις</label>
                <textarea id="notesInput" rows="3" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
            </div>
            <div class="col-span-1 md:col-span-2 flex justify-end gap-4 mt-4">
                <button type="button" onclick="document.getElementById('addDialog').close()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Ακύρωση</button>
                <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-secondary">Αποθήκευση</button>
            </div>
        </form>
    </dialog>

    <dialog id="payDialog" class="p-6 rounded-2xl shadow-xl dark:bg-gray-800 dark:text-white">
      <h3 class="text-2xl font-bold mb-4">Καταγραφή Πληρωμής</h3>
      <form id="payForm" class="space-y-4">
          <input type="hidden" id="payExpenseId">
          <div class="space-y-2">
              <label for="payAmount" class="block font-medium">Ποσό (€)</label>
              <input type="number" id="payAmount" step="0.01" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div class="space-y-2">
              <label for="payDate" class="block font-medium">Ημερομηνία Πληρωμής</label>
              <input type="date" id="payDate" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div class="space-y-2">
              <label for="payMethod" class="block font-medium">Τρόπος Πληρωμής</label>
              <div class="flex gap-2">
                <select id="payMethod" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                    </select>
                <button type="button" id="addPayMethod" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600" title="Προσθήκη νέου τρόπου πληρωμής">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
              </div>
          </div>
          <div class="space-y-2">
              <label for="payTransactionNumber" class="block font-medium">Αριθμός Συναλλαγής (προαιρετικό)</label>
              <input type="text" id="payTransactionNumber" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div class="space-y-2">
              <label for="payNotes" class="block font-medium">Σημειώσεις (προαιρετικό)</label>
              <textarea id="payNotes" rows="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
          </div>
          <div class="flex justify-end gap-4 mt-4">
              <button type="button" onclick="document.getElementById('payDialog').close()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Ακύρωση</button>
              <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-secondary">Αποθήκευση</button>
          </div>
      </form>
    </dialog>

    <dialog id="historyDialog" class="p-6 rounded-2xl shadow-xl dark:bg-gray-800 dark:text-white">
      <h3 class="text-2xl font-bold mb-4">Ιστορικό Πληρωμών</h3>
      <div id="paymentHistoryList" class="space-y-4">
          </div>
      <div class="flex justify-end gap-4 mt-6">
          <button type="button" id="undoPaymentBtn" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600" style="display: none;">Αναίρεση Τελευταίας Πληρωμής</button>
          <button type="button" onclick="document.getElementById('historyDialog').close()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Κλείσιμο</button>
      </div>
    </dialog>

    <dialog id="bulkDialog" class="p-6 rounded-2xl shadow-xl dark:bg-gray-800 dark:text-white w-full max-w-lg">
      <h3 class="text-2xl font-bold mb-4">Μαζική Ενημέρωση Κατάστασης</h3>
      <div id="bulkList" class="space-y-3 max-h-[60vh] overflow-y-auto">
          </div>
      <div class="flex justify-end gap-4 mt-6 border-t pt-4 border-gray-200 dark:border-gray-700">
          <button type="button" onclick="document.getElementById('bulkDialog').close()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Ακύρωση</button>
          <button type="button" id="bulkSave" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-secondary">Αποθήκευση Αλλαγών</button>
      </div>
    </dialog>

    <dialog id="categoryDialog" class="p-6 rounded-2xl shadow-xl dark:bg-gray-800 dark:text-white w-full max-w-md">
        <h3 class="text-2xl font-bold mb-4">Διαχείριση Κατηγοριών</h3>
        
        <form id="categoryForm" class="space-y-4 mb-6 p-4 rounded-lg bg-gray-100 dark:bg-gray-900">
            <h4 class="text-lg font-semibold">Προσθήκη / Επεξεργασία</h4>
            <input type="hidden" id="categoryId">
            <div class="space-y-2">
                <label for="categoryLabel" class="block font-medium">Όνομα Κατηγορίας</label>
                <input type="text" id="categoryLabel" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="space-y-2">
                <label for="categoryIcon" class="block font-medium">Εικονίδιο (Emoji)</label>
                <input type="text" id="categoryIcon" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" id="addCategoryBtn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Νέα Κατηγορία</button>
                <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-secondary">Αποθήκευση</button>
            </div>
        </form>
        
        <div class="space-y-4">
            <h4 class="text-lg font-semibold">Υπάρχουσες Κατηγορίες</h4>
            <ul id="categoryList" class="divide-y divide-gray-200 dark:divide-gray-700">
                </ul>
        </div>

        <div class="flex justify-end mt-6">
            <button type="button" onclick="document.getElementById('categoryDialog').close()" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Κλείσιμο</button>
        </div>
    </dialog>

    <dialog id="confirmation-dialog" class="p-6 rounded-2xl shadow-xl dark:bg-gray-800 dark:text-white">
      <p id="confirmation-text" class="text-lg mb-6"></p>
      <div class="flex justify-end gap-4">
          <button id="confirm-cancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Ακύρωση</button>
          <button id="confirm-ok" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Επιβεβαίωση</button>
      </div>
    </dialog>

    <script>
    // =========================
    // Utilities & State
    // =========================
    const STORAGE_KEY = 'expenses_pro_v1';
    const THEME_KEY = 'theme_pref_v1';
    const CATEGORY_KEY = 'categories_v2';
    const PAYMENT_METHOD_KEY = 'payment_methods_v1';

    const el = id => document.getElementById(id);
    const fmtEUR = n => (Number(n)||0).toLocaleString('el-GR', {style:'currency', currency:'EUR'});
    const isMobile = () => window.innerWidth < 1024; // Use lg breakpoint for mobile detection

    let state = {
      expenses: [],
      currentViewDate: new Date(),
      filterCategory: '',
      statusFilter: '',
      search: '',
      sort: 'dueDateAsc'
    };
    
    // Default categories, used if localStorage is empty
    const defaultCategories = [
      { id:'home', label:'🏠 Σπίτι', icon:'🏠' },
      { id:'transport', label:'🚗 Μεταφορά', icon:'🚗' },
      { id:'entertainment', label:'🎬 Ψυχαγωγία', icon:'🎬' },
      { id:'utilities', label:'⚡ Λογαριασμοί', icon:'⚡' },
      { id:'food', label:'🍔 Φαγητό', icon:'🍔' },
      { id:'health', label:'🩺 Υγεία', icon:'🩺' },
      { id:'education', label:'📚 Εκπαίδευση', icon:'📚' },
      { id:'other', label:'🗂️ Άλλα', icon:'🗂️' }
    ];
    
    // Default payment methods
    const defaultPaymentMethods = [
        { id: 'cash', label: 'Μετρητά' },
        { id: 'card', label: 'Κάρτα' },
        { id: 'bank_transfer', label: 'Τραπεζική Μεταφορά' }
    ];

    // Seed demo data and migrate if needed
    function seedIfEmpty() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) {
        state.expenses = [
          mkExpense('Ενοίκιο', 650, 'home', addDays(new Date(), 10), false, 'Μηνιαία υποχρέωση', 1),
          mkExpense('ΔΕΗ', 85.45, 'utilities', addDays(new Date(), 3), false, 'Τελευταία ειδοποίηση', 0),
          mkExpense('Internet', 30, 'utilities', addDays(new Date(), 5), false, 'Πληρώθηκε μέσω e-banking', 1),
          mkExpense('Super Market', 120.90, 'food', addDays(new Date(), 2), false, '', 0),
          mkExpense('Κινητό', 17.50, 'utilities', addDays(new Date(), 18), false, '', 0),
        ];
        persist();
      } else {
        try { 
            state.expenses = JSON.parse(saved); 
            // Migrate old data model if needed
            state.expenses.forEach(exp => {
                // Check for old boolean 'paid' field and no payments array
                if (typeof exp.paid !== 'undefined' && !exp.payments) {
                    exp.payments = [];
                    if (exp.paid) {
                        const paymentDate = exp.paymentDates?.[0] || exp.createdAt.split('T')[0];
                        exp.payments.push({
                            amount: exp.amount,
                            date: paymentDate,
                            method: 'migration',
                            notes: 'Αρχική πληρωμή (μετανάστευση δεδομένων)',
                            transactionNumber: ''
                        });
                    }
                    delete exp.paid;
                    delete exp.paymentDates;
                }
            });
        } catch { state.expenses = []; }
      }
      const catSaved = localStorage.getItem(CATEGORY_KEY);
      if (!catSaved) localStorage.setItem(CATEGORY_KEY, JSON.stringify(defaultCategories));
      const payMethodSaved = localStorage.getItem(PAYMENT_METHOD_KEY);
      if (!payMethodSaved) localStorage.setItem(PAYMENT_METHOD_KEY, JSON.stringify(defaultPaymentMethods));
    }

    function mkExpense(title, amount, category, dueDate, paid=false, notes='', repeatInterval=0) {
      return {
        id: crypto.randomUUID(),
        title: String(title).trim(),
        amount: Number(amount)||0,
        category: category || 'other',
        dueDate: toYMD(dueDate),
        notes: String(notes||''),
        repeatInterval: Number(repeatInterval) || 0,
        createdAt: new Date().toISOString(),
        payments: []
      };
    }

    function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.expenses)); }
    function persistCategories(){ localStorage.setItem(CATEGORY_KEY, JSON.stringify(getCategories())); }
    function persistPaymentMethods(){ localStorage.setItem(PAYMENT_METHOD_KEY, JSON.stringify(getPaymentMethods())); }

    function addMonths(date, months) {
        let d = new Date(date);
        d.setMonth(d.getMonth() + months);
        return d;
    }

    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function toYMD(d){ if(!d) return ''; const dt=new Date(d); const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const day=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function fromYMD(s){ return s? new Date(s+'T00:00:00'): null; }
    
    // Simple notification system
    function notify(msg, type='info'){
      const colors = {
        info:'bg-gray-900 text-white',
        success:'bg-green-600 text-white',
        error:'bg-red-600 text-white',
        warn:'bg-yellow-500 text-black'
      };
      const n = document.createElement('div');
      n.className = `notification ${colors[type]||colors.info} px-4 py-2 rounded shadow-lg`;
      n.textContent = msg;
      el('notifications').appendChild(n);
      setTimeout(()=>{ n.remove(); }, 2500);
    }
    
    // Confirmation dialog
    function showConfirmation(message, onConfirm) {
      const dialog = el('confirmation-dialog');
      el('confirmation-text').textContent = message;

      // Set up event listeners for the buttons
      const okBtn = el('confirm-ok');
      const cancelBtn = el('confirm-cancel');

      // We use .onclick to prevent multiple event listeners from stacking up
      okBtn.onclick = () => {
        dialog.close();
        onConfirm();
      };
      cancelBtn.onclick = () => {
        dialog.close();
      };
      
      // Show the dialog as a modal, blocking other interactions
      dialog.showModal();
    }


    // =========================
    // Theme
    // =========================
    function applyStoredTheme(){
      const pref = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
      document.documentElement.classList.toggle('dark', pref==='dark');
      el('themeIcon').textContent = pref==='dark'?'☀️':'🌙';
    }
    function toggleTheme(){
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem(THEME_KEY, isDark?'dark':'light');
      el('themeIcon').textContent = isDark?'☀️':'🌙';
    }

    // =========================
    // Rendering
    // =========================
    function renderHeader(){
      const currentMonth = state.currentViewDate.toLocaleDateString('el-GR', { month: 'long', year: 'numeric' });
      el('currentMonth').textContent = `${currentMonth.charAt(0).toUpperCase() + currentMonth.slice(1)}`;
      el('year').textContent = new Date().getFullYear();
    }
    
    function changeMonth(offset) {
        state.currentViewDate.setMonth(state.currentViewDate.getMonth() + offset);
        renderAll();
    }

    function getCategories(){ try { return JSON.parse(localStorage.getItem(CATEGORY_KEY))||defaultCategories; } catch { return defaultCategories; } }
    function getPaymentMethods(){ try { return JSON.parse(localStorage.getItem(PAYMENT_METHOD_KEY))||defaultPaymentMethods; } catch { return defaultPaymentMethods; } }

    function renderFilters(){
      const cats = [{ id: '', label: 'Όλες οι Κατηγορίες', icon: '' }, ...getCategories()];
      const wrap = document.getElementById('categoryFilters');
      wrap.innerHTML = '';
      // Render filter buttons
      cats.forEach(c=>{
        const btn = document.createElement('button');
        btn.className = `px-3 py-1 rounded-full text-sm transition-colors ${state.filterCategory===c.id ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`;
        btn.textContent = c.label;
        btn.addEventListener('click', ()=>{ state.filterCategory=c.id; renderAll(); });
        wrap.appendChild(btn);
      });
      // Render select options for add dialog
      const categorySelect = el('categoryInput');
      categorySelect.innerHTML = '';
      getCategories().forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.label;
        categorySelect.appendChild(option);
      });
    }
    
    function renderPaymentMethods() {
        const select = el('payMethod');
        select.innerHTML = '';
        getPaymentMethods().forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.label;
            select.appendChild(option);
        });
    }
    
    function getFilteredExpenses() {
        const year = state.currentViewDate.getFullYear();
        const month = state.currentViewDate.getMonth();
        return state.expenses.filter(x => {
            const expenseDate = fromYMD(x.dueDate);
            return expenseDate && expenseDate.getFullYear() === year && expenseDate.getMonth() === month;
        });
    }

    function applyFilters(expenses){
      let items = [...expenses];
      if (state.filterCategory) items = items.filter(x=> x.category===state.filterCategory);
      if (state.statusFilter==='paid') items = items.filter(x=> x.payments && x.payments.length > 0);
      if (state.statusFilter==='unpaid') items = items.filter(x=> !x.payments || x.payments.length === 0);
      if (state.search){
        const q = state.search.toLowerCase();
        items = items.filter(x=> x.title.toLowerCase().includes(q) || (x.notes||'').toLowerCase().includes(q));
      }
      switch(state.sort){
        case 'dueDateAsc': items.sort((a,b)=> (a.dueDate||'').localeCompare(b.dueDate||'')); break;
        case 'dueDateDesc': items.sort((a,b)=> (b.dueDate||'').localeCompare(a.dueDate||'')); break;
        case 'amountDesc': items.sort((a,b)=> b.amount - a.amount); break;
        case 'amountAsc': items.sort((a,b)=> a.amount - b.amount); break;
        case 'titleAsc': items.sort((a,b)=> a.title.localeCompare(b.title)); break;
      }
      return items;
    }

    function renderStats(){
      const monthlyExpenses = getFilteredExpenses();
      const total = monthlyExpenses.length;
      const paid = monthlyExpenses.filter(x => x.payments && x.payments.length > 0).length;
      const unpaid = total - paid;
      const sum = monthlyExpenses.reduce((acc,x)=> acc + (Number(x.amount)||0), 0);
      el('totalExpensesCount').textContent = String(total);
      el('paidCount').textContent = String(paid);
      el('unpaidCount').textContent = String(unpaid);
      el('totalAmount').textContent = fmtEUR(sum);
    }

    function renderReminders(){
      const holder = el('upcomingReminders');
      holder.innerHTML = '';
      
      const unpaid = state.expenses
        .filter(x => !x.payments || x.payments.length === 0)
        .sort((a,b) => (a.dueDate||'').localeCompare(b.dueDate||''));
        
      if (!unpaid.length){
        holder.innerHTML = `<div class="text-gray-500">Δεν υπάρχουν ανεξόφλητα έξοδα.</div>`;
        return;
      }
      
      unpaid.forEach(x => {
        const d = new Date(x.dueDate).toLocaleDateString('el-GR');
        const row = document.createElement('div');
        row.className = "flex items-center justify-between bg-white dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2";
        row.innerHTML = `
          <div class="text-sm"><span class="font-semibold">${x.title}</span> — <span class="opacity-80">${d}</span></div>
          <div class="font-bold">${fmtEUR(x.amount)}</div>
        `;
        holder.appendChild(row);
      });
    }

    function renderList(){
      const list = el('expenseList');
      list.innerHTML = '';
      const monthlyExpenses = getFilteredExpenses();
      const filtered = applyFilters(monthlyExpenses);
      const getCategoryLabel = (id) => {
        const cat = getCategories().find(c => c.id === id);
        return cat ? (isMobile() ? cat.icon : cat.label) : id;
      };

      if (!filtered.length){
        list.innerHTML = `<li class="p-6 text-center text-gray-500">Δεν βρέθηκαν έξοδα που να ταιριάζουν με τα φίλτρα.</li>`;
        return;
      }

      filtered.forEach(x=>{
        const li = document.createElement('li');
        li.dataset.id = x.id;
        li.className = "group relative transition-all";
        const isPaid = x.payments && x.payments.length > 0;
        const paidClass = isPaid ? 'line-through opacity-60' : '';
        
        li.innerHTML = `
        <div class="absolute inset-y-0 -left-6 flex items-center justify-center w-6">
            <div class="drag-handle w-4 h-4 rounded-full bg-gray-400 dark:bg-gray-600"></div>
        </div>

        <div class="lg:hidden flex flex-col gap-2 p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <button class="toggle-status-btn" data-id="${x.id}" aria-label="Εναλλαγή κατάστασης πληρωμής">
                        <div class="w-6 h-6 rounded-full border-2 border-current ${isPaid ? 'bg-green-500 border-green-500' : ''}"></div>
                    </button>
                    <div class="font-medium ${paidClass}">${x.title}</div>
                </div>
                <div class="font-bold text-lg ${paidClass}">${fmtEUR(x.amount)}</div>
            </div>
            <div class="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
                <div class="flex items-center gap-2">
                    <span>${getCategoryLabel(x.category)}</span>
                    <span class="text-xs font-semibold uppercase rounded-full px-2 py-1 ${isPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${isPaid ? 'ΠΛΗΡΩΜΕΝΟ' : 'ΑΝΕΞΟΦΛΗΤΟ'}</span>
                </div>
                <div>${new Date(x.dueDate).toLocaleDateString('el-GR')}</div>
            </div>
            <div class="flex items-center gap-2 mt-2">
                <button class="edit-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${x.id}" title="Επεξεργασία">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13.5l-5 5v3h3l5-5-3-3zM16 5l-4.5 4.5M19 8l-4.5-4.5"></path></svg>
                </button>
                ${isPaid ?
                `<button class="history-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${x.id}" title="Ιστορικό Πληρωμών">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>` :
                `<button class="pay-btn p-2 rounded-full bg-green-500 text-white hover:bg-green-600" data-id="${x.id}" title="Καταγραφή Πληρωμής">
                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0v5m-5-5a4 4 0 100 8h2m6-8a4 4 0 110 8h2m-6-4h4m-5 4h8a2 2 0 002-2v-2a2 2 0 00-2-2h-8a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg>
                </button>`
                }
                <button class="delete-btn p-2 rounded-full hover:bg-red-200 dark:hover:bg-red-700" data-id="${x.id}" title="Διαγραφή">
                  <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </div>

        <div class="hidden lg:grid grid-cols-[32px_1fr_110px_130px_120px_100px_140px] items-center gap-3 p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer">
          <button class="toggle-status-btn" data-id="${x.id}" aria-label="Εναλλαγή κατάστασης πληρωμής">
            <div class="w-6 h-6 rounded-full border-2 border-current ${isPaid ? 'bg-green-500 border-green-500' : ''}"></div>
          </button>
          <div class="space-y-1">
            <div class="font-medium ${paidClass}">${x.title}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400 overflow-hidden text-ellipsis whitespace-nowrap">${x.notes}</div>
          </div>
          <div class="font-semibold text-right ${paidClass}">${fmtEUR(x.amount)}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 ${paidClass}">${getCategoryLabel(x.category)}</div>
          <div class="text-sm font-light ${paidClass}">${new Date(x.dueDate).toLocaleDateString('el-GR')}</div>
          <div class="text-xs text-center font-semibold uppercase rounded-full px-2 py-1 ${paidClass} ${isPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
            ${isPaid ? 'ΠΛΗΡΩΜΕΝΟ' : 'ΑΝΕΞΟΦΛΗΤΟ'}
          </div>
          <div class="flex items-center gap-2">
            <button class="edit-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${x.id}" title="Επεξεργασία">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13.5l-5 5v3h3l5-5-3-3zM16 5l-4.5 4.5M19 8l-4.5-4.5"></path></svg>
            </button>
            ${isPaid ?
            `<button class="history-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${x.id}" title="Ιστορικό Πληρωμών">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>` :
            `<button class="pay-btn px-3 py-1 rounded-lg bg-green-500 text-white hover:bg-green-600" data-id="${x.id}" title="Καταγραφή Πληρωμής">
              <svg class="w-4 h-4 mr-1 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0v5m-5-5a4 4 0 100 8h2m6-8a4 4 0 110 8h2m-6-4h4m-5 4h8a2 2 0 002-2v-2a2 2 0 00-2-2h-8a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg>
               Πληρωμή
            </button>`
            }
            <button class="delete-btn p-2 rounded-full hover:bg-red-200 dark:hover:bg-red-700" data-id="${x.id}" title="Διαγραφή">
              <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
        </div>
        `;
        list.appendChild(li);
      });

      // Initialize Sortable.js
      new Sortable(list, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: (evt) => {
          const itemEl = evt.item;
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          const item = filtered.find(x => x.id === itemEl.dataset.id);
          
          if(oldIndex !== newIndex) {
            const reorderedItems = applyFilters(getFilteredExpenses());
            const movedItem = reorderedItems.splice(oldIndex, 1)[0];
            reorderedItems.splice(newIndex, 0, movedItem);
            
            const newExpenseOrder = reorderedItems.map(item => item.id);
            state.expenses.sort((a,b) => newExpenseOrder.indexOf(a.id) - newExpenseOrder.indexOf(b.id));

            persist();
          }
        }
      });
    }

    function renderAll(){
      renderHeader();
      renderFilters();
      renderPaymentMethods();
      renderStats();
      renderReminders();
      renderList();
    }

    // =========================
    // Actions
    // =========================
    function getExpenseById(id){ return state.expenses.find(x => x.id === id); }
    function deleteExpense(id){
      const exp = getExpenseById(id);
      showConfirmation(`Είστε σίγουροι ότι θέλετε να διαγράψετε το έξοδο "${exp.title}"; Αυτή η ενέργεια δεν αναστρέφεται.`, () => {
        state.expenses = state.expenses.filter(x=>x.id!==id);
        persist();
        renderAll();
        notify('Το έξοδο διαγράφηκε.', 'success');
      });
    }

    function handleStatusClick(id) {
        const exp = getExpenseById(id);
        if (!exp) return;
        if (exp.payments && exp.payments.length > 0) {
            showPaymentHistory(id);
        } else {
            openPayDialog(id);
        }
    }
    
    function openAddDialog(id){
      const dialog = el('addDialog');
      const form = el('addForm');
      const expense = id ? getExpenseById(id) : null;
      
      form.reset();
      el('expenseId').value = id || '';
      
      if(expense){
        el('titleInput').value = expense.title;
        el('amountInput').value = expense.amount;
        el('categoryInput').value = expense.category;
        el('dueDateInput').value = expense.dueDate;
        el('repeatInput').value = expense.repeatInterval;
        el('notesInput').value = expense.notes;
      } else {
        // Set default due date to the last day of the current view month
        const lastDayOfMonth = new Date(state.currentViewDate.getFullYear(), state.currentViewDate.getMonth() + 1, 0);
        el('dueDateInput').value = toYMD(lastDayOfMonth);
      }
      dialog.showModal();
    }
    
    function saveExpense(e){
      e.preventDefault();
      const id = el('expenseId').value;
      const title = el('titleInput').value;
      const amount = el('amountInput').value;
      const category = el('categoryInput').value;
      const dueDate = el('dueDateInput').value;
      const repeatInterval = el('repeatInput').value;
      const notes = el('notesInput').value;
      
      if(id){
        const exp = getExpenseById(id);
        if(exp){
          Object.assign(exp, { title, amount, category, dueDate, notes, repeatInterval });
          notify('Το έξοδο ενημερώθηκε!', 'success');
        }
      } else {
        const newExp = mkExpense(title, amount, category, dueDate, false, notes, repeatInterval);
        state.expenses.unshift(newExp);
        notify('Το έξοδο προστέθηκε!', 'success');
      }
      
      persist();
      renderAll();
      el('addDialog').close();
    }

    function openPayDialog(id){
      const dialog = el('payDialog');
      const expense = getExpenseById(id);
      if(!expense) return;
      
      el('payExpenseId').value = id;
      el('payAmount').value = expense.amount;
      el('payDate').value = toYMD(new Date());
      el('payNotes').value = '';
      el('payTransactionNumber').value = '';

      renderPaymentMethods();
      dialog.showModal();
    }
    
    // New, correct handlePayment() function
    function handlePayment(e) {
        e.preventDefault();
        const id = el('payExpenseId').value;
        const exp = getExpenseById(id);
        if (!exp) return;

        const newPayment = {
            amount: Number(el('payAmount').value) || 0,
            date: el('payDate').value,
            method: el('payMethod').value,
            notes: el('payNotes').value,
            transactionNumber: el('payTransactionNumber').value
        };

        if (!exp.payments) exp.payments = [];
        exp.payments.push(newPayment);

        persist();
        renderAll();
        notify('Η πληρωμή καταγράφηκε με επιτυχία!', 'success');
        el('payDialog').close();
    }

    function openBulkDialog() {
        renderBulkList();
        el('bulkDialog').showModal();
    }
    
    function renderBulkList() {
        const bulkList = el('bulkList');
        bulkList.innerHTML = '';
        const monthlyExpenses = applyFilters(getFilteredExpenses());

        if (monthlyExpenses.length === 0) {
            bulkList.innerHTML = `<p class="p-4 text-center text-gray-500">Δεν υπάρχουν έξοδα για αυτόν τον μήνα.</p>`;
            return;
        }

        monthlyExpenses.forEach(exp => {
            const isPaid = exp.payments && exp.payments.length > 0;
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors';
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="h-5 w-5 rounded form-checkbox text-green-600 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-600" data-id="${exp.id}" ${isPaid ? 'checked' : ''}>
                    <div>
                        <div class="font-medium">${exp.title}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${fmtEUR(exp.amount)} - ${new Date(exp.dueDate).toLocaleDateString('el-GR')}</div>
                    </div>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    ${(exp.payments && exp.payments.length > 0) ? `Πληρωμένο` : `Ανεξόφλητο`}
                </div>
            `;
            bulkList.appendChild(item);
        });
    }

    function handleBulkSave() {
        const checkboxes = el('bulkList').querySelectorAll('input[type="checkbox"]');
        const now = toYMD(new Date());
        
        checkboxes.forEach(cb => {
            const id = cb.dataset.id;
            const exp = getExpenseById(id);
            if (!exp) return;

            const wasPaid = exp.payments && exp.payments.length > 0;
            const isNowPaid = cb.checked;
            
            if (isNowPaid && !wasPaid) {
                // Mark as paid
                if (!exp.payments) exp.payments = [];
                exp.payments.push({
                    amount: exp.amount,
                    date: now,
                    method: 'bulk_update',
                    notes: 'Καταχώρηση μέσω μαζικής ενημέρωσης',
                    transactionNumber: ''
                });
            } else if (!isNowPaid && wasPaid) {
                // Unmark as paid (undo last payment)
                exp.payments.pop();
            }
        });

        persist();
        renderAll();
        notify('Οι αλλαγές αποθηκεύτηκαν με επιτυχία!', 'success');
        el('bulkDialog').close();
    }


    async function exportData(){
        const data = JSON.stringify(state.expenses, null, 2);
        const fileName = `expenses_export_${toYMD(new Date())}.json`;
        
        if ('showSaveFilePicker' in window) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'JSON Files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });
                const writable = await handle.createWritable();
                await writable.write(data);
                await writable.close();
                notify('Τα δεδομένα εξήχθησαν!', 'success');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error(err);
                    notify('Αποτυχία εξαγωγής. Δοκιμάστε ξανά.', 'error');
                }
            }
        } else {
            // Fallback for browsers without showSaveFilePicker
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            notify('Τα δεδομένα εξήχθησαν! (Αποθηκεύτηκαν στο φάκελο Λήψεων)', 'success');
        }
    }

    function importData(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const importedExpenses = JSON.parse(event.target.result);
          if (Array.isArray(importedExpenses) && importedExpenses.every(x => x.id && x.title)){
            state.expenses = importedExpenses;
            persist();
            renderAll();
            notify('Τα δεδομένα εισήχθησαν με επιτυχία!', 'success');
          } else {
            throw new Error('Invalid JSON format');
          }
        } catch (err){
          notify('Αποτυχία εισαγωγής. Μη έγκυρο αρχείο JSON.', 'error');
          console.error(err);
        }
      };
      reader.readAsText(file);
    }

    function generatePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(22);
      doc.text("Μηνιαία Έξοδα Pro", 14, 20);
      doc.setFont("Helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Εξαγωγή για τον μήνα: ${el('currentMonth').textContent}`, 14, 26);
      
      const tableData = applyFilters(getFilteredExpenses()).map(exp => [
        exp.title,
        fmtEUR(exp.amount),
        getCategories().find(c => c.id === exp.category)?.label || exp.category,
        new Date(exp.dueDate).toLocaleDateString('el-GR'),
        (exp.payments && exp.payments.length > 0) ? 'Πληρωμένο' : 'Ανεξόφλητο'
      ]);

      doc.autoTable({
        startY: 35,
        head: [['Τίτλος', 'Ποσό', 'Κατηγορία', 'Ημ/νία Λήξης', 'Κατάσταση']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [93, 92, 222] }, // Primary color
        styles: { font: 'Helvetica', fontSize: 10, cellPadding: 2 },
        columnStyles: { 1: { halign: 'right' } }
      });
      
      doc.save(`monthly_expenses_${toYMD(new Date())}.pdf`);
      notify('Το PDF δημιουργήθηκε!', 'success');
    }
    
    // =========================
    // Category Management
    // =========================
    function openCategoryDialog() {
        renderCategoryList();
        el('categoryDialog').showModal();
        el('categoryForm').reset();
    }
    
    function renderCategoryList() {
        const list = el('categoryList');
        list.innerHTML = '';
        const cats = getCategories();
        
        if (cats.length === 0) {
            list.innerHTML = `<li class="py-2 text-center text-gray-500">Δεν υπάρχουν κατηγορίες.</li>`;
            return;
        }
        
        cats.forEach(c => {
            const li = document.createElement('li');
            li.className = "flex justify-between items-center py-2";
            li.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">${c.icon}</span>
                    <span>${c.label}</span>
                </div>
                <div class="space-x-2">
                    <button class="edit-category-btn text-sm text-primary" data-id="${c.id}">Επεξεργασία</button>
                    <button class="delete-category-btn text-sm text-red-600" data-id="${c.id}">Διαγραφή</button>
                </div>
            `;
            list.appendChild(li);
        });
    }
    
    function handleCategoryFormSubmit(e) {
        e.preventDefault();
        const id = el('categoryId').value || crypto.randomUUID();
        const label = el('categoryLabel').value;
        const icon = el('categoryIcon').value;
        
        let cats = getCategories();
        const existingIndex = cats.findIndex(c => c.id === id);
        
        if (existingIndex !== -1) {
            cats[existingIndex] = { id, label, icon };
            notify('Η κατηγορία ενημερώθηκε!', 'success');
        } else {
            cats.push({ id, label, icon });
            notify('Η κατηγορία προστέθηκε!', 'success');
        }
        
        localStorage.setItem(CATEGORY_KEY, JSON.stringify(cats));
        renderCategoryList();
        renderFilters();
        el('categoryForm').reset();
    }
    
    function deleteCategory(id) {
        const cats = getCategories();
        const otherCategory = cats.find(c => c.id === 'other');
        
        if (id === 'other') {
            notify('Δεν μπορείς να διαγράψεις την προεπιλεγμένη κατηγορία "Άλλα".', 'error');
            return;
        }
        
        if (!otherCategory) {
            notify('Δεν βρέθηκε η κατηγορία "Άλλα". Η διαγραφή δεν είναι δυνατή.', 'error');
            return;
        }

        showConfirmation(`Είστε σίγουροι ότι θέλετε να διαγράψετε αυτή την κατηγορία; Όλα τα έξοδα που συνδέονται με αυτήν θα μεταφερθούν στην κατηγορία "Άλλα".`, () => {
          // Reassign expenses to 'other' category
          state.expenses.forEach(exp => {
              if (exp.category === id) {
                  exp.category = 'other';
              }
          });
          
          const updatedCats = cats.filter(c => c.id !== id);
          
          localStorage.setItem(CATEGORY_KEY, JSON.stringify(updatedCats));
          persist(); // Persist the updated expenses
          renderCategoryList();
          renderFilters();
          renderList();
          notify('Η κατηγορία διαγράφηκε.', 'success');
        });
    }
    
    function editCategory(id) {
        const cats = getCategories();
        const category = cats.find(c => c.id === id);
        if (category) {
            el('categoryId').value = category.id;
            el('categoryLabel').value = category.label;
            el('categoryIcon').value = category.icon;
            el('categoryForm').scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    // =========================
    // Payment History & Undo
    // =========================
    function showPaymentHistory(id) {
        const exp = getExpenseById(id);
        const list = el('paymentHistoryList');
        const undoBtn = el('undoPaymentBtn');
        
        list.innerHTML = '';
        undoBtn.style.display = 'none';

        if (!exp || !exp.payments || exp.payments.length === 0) {
            list.innerHTML = `<div class="text-gray-500">Δεν υπάρχουν καταχωρημένες πληρωμές για αυτό το έξοδο.</div>`;
        } else {
            exp.payments.forEach(p => {
                const method = getPaymentMethods().find(m => m.id === p.method)?.label || p.method;
                const date = new Date(p.date).toLocaleDateString('el-GR');
                const li = document.createElement('div');
                li.className = 'py-3 px-4 rounded-lg bg-gray-100 dark:bg-gray-800 space-y-1';
                li.innerHTML = `
                    <div class="font-semibold">${fmtEUR(p.amount)}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      <div>${date} - ${method}</div>
                      ${p.transactionNumber ? `<div>Αρ. Συναλλαγής: ${p.transactionNumber}</div>` : ''}
                      ${p.notes ? `<div>Σημειώσεις: ${p.notes}</div>` : ''}
                    </div>
                `;
                list.appendChild(li);
            });
            undoBtn.dataset.id = id;
            undoBtn.style.display = 'block';
        }
        el('historyDialog').showModal();
    }

    function undoLastPayment(expenseId) {
        const expense = getExpenseById(expenseId);
        if (expense && expense.payments && expense.payments.length > 0) {
            const lastPayment = expense.payments[expense.payments.length - 1];
            showConfirmation(`Είστε σίγουροι ότι θέλετε να αναιρέσετε την τελευταία πληρωμή ύψους €${lastPayment.amount.toFixed(2)};`, () => {
                expense.payments.pop();
                persist();
                renderAll();
                showPaymentHistory(expenseId);
                notify(`Αναιρέθηκε η πληρωμή €${lastPayment.amount.toFixed(2)} για το έξοδο "${expense.title}".`, 'success');
            });
        } else {
            notify('Δεν υπάρχουν πληρωμές για αναίρεση σε αυτό το έξοδο.', 'error');
        }
    }
    
    function handleAddPayMethod() {
      const newMethodLabel = prompt("Εισάγετε νέο τρόπο πληρωμής:");
      if (newMethodLabel && newMethodLabel.trim()) {
          const newMethodId = newMethodLabel.trim().toLowerCase().replace(/\s+/g, '_');
          const methods = getPaymentMethods();
          if (!methods.find(m => m.id === newMethodId)) {
              methods.push({ id: newMethodId, label: newMethodLabel });
              localStorage.setItem(PAYMENT_METHOD_KEY, JSON.stringify(methods));
              renderPaymentMethods();
              el('payMethod').value = newMethodId;
              notify('Προστέθηκε νέος τρόπος πληρωμής!', 'success');
          } else {
              notify('Ο τρόπος πληρωμής υπάρχει ήδη.', 'warn');
          }
      }
    }

    // New function to check and create recurring expenses
    function checkAndCreateRecurringExpenses() {
        const today = new Date();
        const currentMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        let changesMade = false;

        const recurringExpenses = state.expenses.filter(x => x.repeatInterval > 0 && x.payments && x.payments.length > 0);
        
        recurringExpenses.forEach(exp => {
            const lastPaymentDate = fromYMD(exp.payments[exp.payments.length - 1].date);
            
            if (!lastPaymentDate) return;

            let nextDueDate = fromYMD(exp.dueDate);
            
            while (nextDueDate < today) {
                nextDueDate = addMonths(nextDueDate, exp.repeatInterval);
            }
            
            if (nextDueDate > currentMonthEnd) {
                return;
            }

            const newInstanceExists = state.expenses.some(e => 
                e.title === exp.title && 
                e.amount === exp.amount &&
                e.category === exp.category &&
                e.dueDate === toYMD(nextDueDate) &&
                (e.payments && e.payments.length === 0)
            );

            if (!newInstanceExists) {
                const newExp = mkExpense(
                    exp.title, 
                    exp.amount, 
                    exp.category, 
                    nextDueDate, 
                    false, 
                    exp.notes, 
                    exp.repeatInterval
                );
                state.expenses.unshift(newExp);
                changesMade = true;
                notify(`Δημιουργήθηκε νέο επαναλαμβανόμενο έξοδο: "${newExp.title}"`, 'info');
            }
        });

        if (changesMade) {
            persist();
        }
    }

    // =========================
    // Event Listeners
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      seedIfEmpty();
      applyStoredTheme();
      
      // Καλούμε τη νέα συνάρτηση εδώ
      checkAndCreateRecurringExpenses(); 
      
      renderAll();

      el('themeToggle').addEventListener('click', toggleTheme);
      el('prevMonthBtn').addEventListener('click', () => changeMonth(-1));
      el('nextMonthBtn').addEventListener('click', () => changeMonth(1));
      el('btnAdd').addEventListener('click', () => openAddDialog());
      el('btnBulk').addEventListener('click', () => openBulkDialog());
      el('btnExport').addEventListener('click', exportData);
      el('btnImport').addEventListener('click', () => el('importInput').click());
      el('btnPDF').addEventListener('click', generatePDF);
      el('btnManageCategories').addEventListener('click', openCategoryDialog);

      el('addForm').addEventListener('submit', saveExpense);
      el('payForm').addEventListener('submit', handlePayment);
      el('bulkSave').addEventListener('click', handleBulkSave);
      el('categoryForm').addEventListener('submit', handleCategoryFormSubmit);
      el('addPayMethod').addEventListener('click', handleAddPayMethod);
      el('undoPaymentBtn').addEventListener('click', (e) => {
          const expenseId = e.target.dataset.id;
          if (expenseId) {
              undoLastPayment(expenseId);
          }
      });
      
      el('categoryList').addEventListener('click', (e) => {
          const target = e.target.closest('button');
          if (!target) return;
          const id = target.dataset.id;
          if (target.classList.contains('edit-category-btn')) {
              editCategory(id);
          } else if (target.classList.contains('delete-category-btn')) {
              deleteCategory(id);
          }
      });
      el('addCategoryBtn').addEventListener('click', () => {
          el('categoryForm').reset();
          el('categoryId').value = '';
          el('categoryLabel').focus();
      });

      el('expenseList').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.dataset.id;
        if(target.classList.contains('toggle-status-btn')) {
          handleStatusClick(id);
        } else if(target.classList.contains('edit-btn')) {
          openAddDialog(id);
        } else if(target.classList.contains('pay-btn')) {
          openPayDialog(id);
        } else if(target.classList.contains('history-btn')) {
          showPaymentHistory(id);
        } else if(target.classList.contains('delete-btn')) {
          deleteExpense(id);
        }
      });

      el('searchInput').addEventListener('input', (e) => {
        state.search = e.target.value;
        renderList();
      });
      el('statusFilter').addEventListener('change', (e) => {
        state.statusFilter = e.target.value;
        renderList();
      });
      el('sortSelect').addEventListener('change', (e) => {
        state.sort = e.target.value;
        renderList();
      });
    });
    
    // === PWA Functionality ===
    
    // Check if the browser supports Service Workers
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // IMPORTANT: Replace <repository-name> with your actual repository name
        navigator.serviceWorker.register('/<repository-name>/sw.js').then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }

    // This code handles the installation prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });
  </script>
</body>
</html>


